<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—…è¡Œè¦åŠƒ</title>
    <!-- â˜… åœ°åœ–APIå¼•å…¥ - å¿…é ˆæ›¿æ›é‡‘é‘° -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCaoU4qICEMFvEGY2AdoCUP-nlVjBj3bSM&libraries=places&callback=initMap" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #8A9EA8; --secondary: #C9B8A3; --accent: #A3C9B8;
            --light: #F8F5F2; --dark: #5A6D73; --text: #333333;
            --shadow: rgba(138, 158, 168, 0.15); --radius: 20px; --radius-sm: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, 'Microsoft JhengHei', sans-serif; }
        body { background-color: var(--light); color: var(--text); min-height: 100vh; padding-bottom: 90px; line-height: 1.6; }

        /* å¯è‡ªè¨‚çš„é é¢èƒŒæ™¯ (æ‡‰ç”¨æ–¼æ•´å€‹ .page) */
        .page-with-bg {
            position: relative;
            border-radius: var(--radius);
            overflow: hidden; /* ç¢ºä¿èƒŒæ™¯åœ–ä¸æº¢å‡ºåœ“è§’ */
            box-shadow: 0 10px 30px var(--shadow);
            border: 1px solid rgba(138, 158, 168, 0.08);
        }
        .page-bg-layer {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.6; /* èƒŒæ™¯åœ–é€æ˜åº¦ 60% */
            z-index: 1;
        }
        .page-content {
            position: relative; /* ç¢ºä¿å…§å®¹åœ¨èƒŒæ™¯åœ–ä¸Šæ–¹ */
            z-index: 2;
            padding: 30px;
            background: rgba(255, 255, 255, 0.85); /* å…§å®¹å€è¼•å¾®ç™½è‰²èƒŒæ™¯ï¼Œæé«˜æ–‡å­—å¯è®€æ€§ */
            border-radius: var(radius);
        }

        /* èƒŒæ™¯è¨­å®šæŒ‰éˆ• */
        .bg-setting-btn {
            position: absolute; top: 15px; right: 15px;
            background: rgba(255, 255, 255, 0.9); 
            border: none; width: 36px; height: 36px;
            border-radius: 50%; font-size: 18px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: all 0.3s; z-index: 3; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
        }
        .bg-setting-btn:hover { background: white; transform: scale(1.1); }
        /* èƒŒæ™¯è¨­å®šé¢æ¿ */
        .bg-setting-panel {
            display: none; position: absolute; top: 60px; right: 15px;
            background: white; padding: 20px; border-radius: var(--radius-sm);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 4; min-width: 250px;
            border: 1px solid rgba(138, 158, 168, 0.1);
        }
        .bg-setting-panel h4 { margin-bottom: 10px; color: var(--dark); }
        .bg-setting-panel input[type="file"] { width: 100%; margin-bottom: 15px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; }
        .bg-setting-panel button { background: var(--accent); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; width: 100%; }

        /* ä¸»å…§å®¹å€ */
        .main-content { padding: 25px; }
        .page { display: none; margin-top: 25px; } /* åŸºç¤æ¨£å¼ï¼Œå¯¦éš›æ¨£å¼ç”± .page-with-bg æä¾› */
        .page.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* æ¨™é¡Œæ¡† - ç½®ä¸­ï¼Œèˆ‡ä¸‹æ–¹ä¿æŒ2cmè·é›¢ */
        .header-title-container {
            text-align: center;
            margin: 0 auto 2cm; /* ä¸‹é‚Šè· 2cm */
            display: flex;
            justify-content: center;
        }
        .title-container {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            padding: 15px 30px;
            border-radius: 50px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            box-shadow: 0 6px 20px var(--shadow);
            max-width: 80%;
        }
        #app-title {
            font-size: 26px;
            font-weight: 700;
            border: none;
            background: transparent;
            color: white;
            text-align: center;
            outline: none;
            min-width: 200px;
            cursor: pointer;
        }

        h2 { color: var(--dark); margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--light); font-size: 24px; display: flex; align-items: center; gap: 10px; }

        /* è¡¨å–® */
        .input-group { margin-bottom: 30px; }
        input, textarea, select {
            width: 100%; padding: 16px 20px; margin: 10px 0; border: 2px solid #eee;
            border-radius: var(--radius-sm); font-size: 16px; transition: all 0.3s; background: #fcfcfc;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent); background: white; box-shadow: 0 0 0 3px rgba(163, 201, 184, 0.2); }
        button.primary-btn {
            background: linear-gradient(to right, var(--primary), var(--accent)); color: white; border: none;
            padding: 17px 30px; border-radius: var(--radius-sm); font-size: 17px; font-weight: 600;
            cursor: pointer; transition: all 0.3s; margin-top: 15px; width: 100%; letter-spacing: 0.5px;
        }
        button.primary-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(138, 158, 168, 0.3); }

        /* åº•éƒ¨å°èˆª */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            display: flex; justify-content: space-around; padding: 18px 0;
            box-shadow: 0 -5px 25px var(--shadow); z-index: 1000; border-top: 1px solid rgba(138, 158, 168, 0.1);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 12px 25px; border-radius: var(--radius-sm); transition: all 0.3s; color: var(--text-light); }
        .nav-item.active { background: rgba(138, 158, 168, 0.1); color: var(--primary); }
        .nav-icon { font-size: 26px; margin-bottom: 6px; }
        .nav-text { font-size: 14px; font-weight: 500; }

        /* è¡Œç¨‹åˆ—è¡¨æ¨£å¼ */
        #itinerary-list { margin-top: 20px; }
        .date-section { margin-bottom: 35px; background: rgba(248, 245, 242, 0.7); border-radius: var(--radius); padding: 25px; border-left: 6px solid var(--accent); }
        .date-header { font-size: 20px; font-weight: 700; color: var(--dark); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px dashed rgba(138, 158, 168, 0.3); }
        .sortable-list { min-height: 20px; }
        .itinerary-item {
            background: white; border-radius: var(--radius-sm); padding: 22px; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid rgba(138, 158, 168, 0.1);
            transition: all 0.3s; cursor: move;
        }
        .itinerary-item:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(138, 158, 168, 0.15); }
        .item-content { flex-grow: 1; }
        .item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .item-title { font-weight: 700; color: var(--text); font-size: 18px; }
        .item-time { color: var(--primary); font-size: 15px; font-weight: 600; background: rgba(138, 158, 168, 0.1); padding: 5px 12px; border-radius: 20px; }
        .item-location { color: var(--text-light); margin: 8px 0; font-size: 15px; }
        .item-remarks { color: var(--text); margin-top: 10px; padding: 12px; background: rgba(201, 184, 163, 0.08); border-radius: 10px; font-size: 15px; border-left: 3px solid var(--secondary); }

        /* åˆªé™¤æŒ‰éˆ• - ä½¿ç”¨æ–°åƒåœ¾æ¡¶åœ–ç¤ºä¸¦ç¸®å° */
        .delete-btn {
            background: url('https://i.pinimg.com/736x/bc/fb/fe/bcfbfe6f458175b4afd8375a69257cb8.jpg') center/contain no-repeat;
            border: none; width: 30px; height: 30px; /* ç¸®å°ç´„5pt */
            cursor: pointer; margin-left: 20px; flex-shrink: 0;
            transition: all 0.3s; opacity: 0.7;
        }
        .delete-btn:hover { opacity: 1; transform: scale(1.1); }

        /* é ç®—å’Œæ—¥è¨˜é …ç›® */
        .budget-item, .diary-entry {
            background: white; border-radius: var(--radius-sm); padding: 22px; margin-bottom: 18px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid rgba(138, 158, 168, 0.1);
        }

        /* åœ°åœ–é é¢ä½ˆå±€ */
        .map-page-layout { display: flex; gap: 20px; height: 500px; margin-top: 20px; }
        #locations-sidebar { flex: 1; background: rgba(249, 249, 249, 0.9); border-radius: var(--radius-sm); padding: 20px; overflow-y: auto; }
        #map-container { flex: 2; border-radius: var(--radius-sm); overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        #map { width: 100%; height: 100%; }
        .location-list-item {
            padding: 15px; margin-bottom: 10px; background: white; border-radius: 8px;
            cursor: pointer; border-left: 4px solid #4b6cb7; transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .location-list-item:hover { background-color: #f0f7ff; }

        @media (max-width: 768px) {
            .page, .main-content { padding: 20px 15px; }
            .bottom-nav { padding: 15px 0; }
            .nav-item { padding: 10px 15px; }
            .map-page-layout { flex-direction: column; height: auto; }
            #map-container { height: 350px; }
        }
    </style>
</head>
<body>
    <!-- ç½®ä¸­çš„æ¨™é¡Œæ¡† -->
    <div class="header-title-container">
        <div class="title-container">
            <input type="text" id="app-title" value="âœˆï¸ æˆ‘çš„æ—…è¡Œè¦åŠƒ" maxlength="30" onclick="this.select();">
        </div>
    </div>

    <!-- é é¢1ï¼šè¡Œç¨‹è¦åŠƒ -->
    <div class="main-content">
        <div id="itinerary-page" class="page-with-bg active">
            <!-- èƒŒæ™¯åœ–å±¤èˆ‡è¨­å®šæŒ‰éˆ• -->
            <div id="itinerary-bg-layer" class="page-bg-layer"></div>
            <button class="bg-setting-btn" onclick="toggleBgPanel('itinerary')">âš™ï¸</button>
            <div id="itinerary-bg-panel" class="bg-setting-panel">
                <h4>æ›´æ”¹èƒŒæ™¯åœ–</h4>
                <input type="file" id="itinerary-bg-input" accept="image/*">
                <button onclick="changeBackground('itinerary')">å¥—ç”¨èƒŒæ™¯</button>
            </div>
            <!-- é é¢ä¸»è¦å…§å®¹ -->
            <div class="page-content">
                <h2>ğŸ“… è¡Œç¨‹è¦åŠƒ</h2>
                <div class="input-group">
                    <input type="text" id="activity-input" placeholder="æ´»å‹•åç¨±">
                    <input type="text" id="location-input" placeholder="åœ°é»">
                    <!-- è¼¸å…¥æ¡†æ¨™é¡Œæ”¹ç‚ºã€Œæ—¥æœŸã€ -->
                    <label for="time-input" style="display:block; margin-top:15px; font-weight:bold; color: var(--dark);">æ—¥æœŸ</label>
                    <input type="datetime-local" id="time-input">
                    <textarea id="remarks-input" placeholder="å‚™è¨»" rows="3"></textarea>
                    <button class="primary-btn" onclick="addActivity()">æ–°å¢æ´»å‹•</button>
                </div>
                <div id="itinerary-list"></div>
            </div>
        </div>
    </div>

    <!-- é é¢2ï¼šè¡Œç¨‹åœ°åœ– -->
    <div class="main-content" style="display:none;" id="map-main-content">
        <div id="map-page" class="page-with-bg">
            <div id="map-bg-layer" class="page-bg-layer"></div>
            <button class="bg-setting-btn" onclick="toggleBgPanel('map')">âš™ï¸</button>
            <div id="map-bg-panel" class="bg-setting-panel">
                <h4>æ›´æ”¹èƒŒæ™¯åœ–</h4>
                <input type="file" id="map-bg-input" accept="image/*">
                <button onclick="changeBackground('map')">å¥—ç”¨èƒŒæ™¯</button>
            </div>
            <div class="page-content">
                <h2>ğŸ—ºï¸ è¡Œç¨‹åœ°åœ–</h2>
                <div class="map-page-layout">
                    <div id="locations-sidebar">
                        <h3>åœ°é»æ¸…å–®</h3>
                        <div id="locations-list"><p style="color: var(--text-light); text-align: center; margin-top: 20px;">è«‹å…ˆåœ¨è¡Œç¨‹é é¢æ·»åŠ åœ°é»</p></div>
                    </div>
                    <div id="map-container"><div id="map"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- é é¢3ï¼šé ç®—è¦åŠƒ -->
    <div class="main-content" style="display:none;" id="budget-main-content">
        <div id="budget-page" class="page-with-bg">
            <div id="budget-bg-layer" class="page-bg-layer"></div>
            <button class="bg-setting-btn" onclick="toggleBgPanel('budget')">âš™ï¸</button>
            <div id="budget-bg-panel" class="bg-setting-panel">
                <h4>æ›´æ”¹èƒŒæ™¯åœ–</h4>
                <input type="file" id="budget-bg-input" accept="image/*">
                <button onclick="changeBackground('budget')">å¥—ç”¨èƒŒæ™¯</button>
            </div>
            <div class="page-content">
                <h2>ğŸ’° é ç®—è¦åŠƒ</h2>
                <div class="input-group">
                    <input type="text" id="expense-name" placeholder="èŠ±è²»é …ç›®">
                    <input type="number" id="expense-amount" placeholder="é‡‘é¡ (æ³°éŠ–)">
                    <select id="expense-category">
                        <option value="">é¸æ“‡åˆ†é¡</option>
                        <option value="food">é¤é£²</option>
                        <option value="shopping">è³¼ç‰©</option>
                        <option value="leisure">ä¼‘é–’å¨›æ¨‚</option>
                    </select>
                    <select id="payment-method">
                        <option value="">æ”¯ä»˜æ–¹å¼</option>
                        <option value="credit">ä¿¡ç”¨å¡</option>
                        <option value="cash">ç¾é‡‘</option>
                    </select>
                    <button class="primary-btn" onclick="addExpense()">è¨˜éŒ„èŠ±è²»</button>
                </div>
                <div style="background: rgba(138, 158, 168, 0.08); padding:25px; border-radius:var(--radius-sm); margin:25px 0;">
                    <h3>é ç®—çµ±è¨ˆ</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                        <div style="text-align: center; padding: 15px; background: white; border-radius: var(--radius-sm);">
                            <div style="font-size: 14px; color: var(--text-light);">ç¸½é ç®—</div>
                            <div style="font-size: 24px; font-weight: 700; color: var(--primary);"><span id="total-budget">10000</span> à¸¿</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: var(--radius-sm);">
                            <div style="font-size: 14px; color: var(--text-light);">å·²èŠ±è²»</div>
                            <div style="font-size: 24px; font-weight: 700; color: #EA5455;"><span id="total-spent">0</span> à¸¿</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: var(--radius-sm);">
                            <div style="font-size: 14px; color: var(--text-light);">å‰©é¤˜</div>
                            <div style="font-size: 24px; font-weight: 700; color: var(--accent);"><span id="remaining">10000</span> à¸¿</div>
                        </div>
                    </div>
                </div>
                <div id="expense-list"></div>
            </div>
        </div>
    </div>

    <!-- é é¢4ï¼šæ—…è¡Œç­†è¨˜ -->
    <div class="main-content" style="display:none;" id="diary-main-content">
        <div id="diary-page" class="page-with-bg">
            <div id="diary-bg-layer" class="page-bg-layer"></div>
            <button class="bg-setting-btn" onclick="toggleBgPanel('diary')">âš™ï¸</button>
            <div id="diary-bg-panel" class="bg-setting-panel">
                <h4>æ›´æ”¹èƒŒæ™¯åœ–</h4>
                <input type="file" id="diary-bg-input" accept="image/*">
                <button onclick="changeBackground('diary')">å¥—ç”¨èƒŒæ™¯</button>
            </div>
            <div class="page-content">
                <h2>ğŸ“ æ—…è¡Œç­†è¨˜</h2>
                <div class="input-group">
                    <input type="text" id="diary-title" placeholder="æ¨™é¡Œ">
                    <textarea id="diary-content" placeholder="å¯«ä¸‹ç­†è¨˜..." rows="6"></textarea>
                    <input type="file" id="diary-image" accept="image/*">
                    <button class="primary-btn" onclick="addDiaryEntry()">æ–°å¢ç­†è¨˜</button>
                </div>
                <div id="diary-list"></div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆªåˆ— (æ–°é †åºï¼šè¡Œç¨‹->åœ°åœ–->é ç®—->ç­†è¨˜) -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="showPage('itinerary')">
            <div class="nav-icon">ğŸ“…</div>
            <div class="nav-text">è¡Œç¨‹</div>
        </div>
        <div class="nav-item" onclick="showPage('map')">
            <div class="nav-icon">ğŸ—ºï¸</div>
            <div class="nav-text">åœ°åœ–</div>
        </div>
        <div class="nav-item" onclick="showPage('budget')">
            <div class="nav-icon">ğŸ’°</div>
            <div class="nav-text">é ç®—</div>
        </div>
        <div class="nav-item" onclick="showPage('diary')">
            <div class="nav-icon">ğŸ“</div>
            <div class="nav-text">ç­†è¨˜</div>
        </div>
    </div>

    <script>
        // ==================== å…¨åŸŸè®Šæ•¸ ====================
        let map; // Google åœ°åœ–å¯¦ä¾‹
        let markers = []; let infoWindows = [];
        let totalSpent = 0; const totalBudget = 10000;
        const activities = []; const dateColors = {};
        const colorPalette = [ 'rgba(163, 201, 184, 0.15)', 'rgba(138, 158, 168, 0.15)', 'rgba(201, 184, 163, 0.15)', 'rgba(168, 138, 153, 0.15)', 'rgba(163, 184, 201, 0.15)' ];

        // ==================== é é¢åˆ‡æ›èˆ‡èƒŒæ™¯æ§åˆ¶ (å·²ä¿®æ”¹) ====================
        function showPage(pageName) {
            const pages = ['itinerary', 'map', 'budget', 'diary'];
            pages.forEach(p => {
                document.getElementById(p + '-page').classList.remove('active');
                document.getElementById(p + '-main-content') && (document.getElementById(p + '-main-content').style.display = 'none');
                document.getElementById(p + '-bg-panel').style.display = 'none';
            });
            document.getElementById(pageName + '-page').classList.add('active');
            document.getElementById(pageName + '-main-content') && (document.getElementById(pageName + '-main-content').style.display = 'block');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if (pageName === 'map' && map) {
                setTimeout(() => google.maps.event.trigger(map, 'resize'), 300);
                updateMapPage();
            }
            loadBackground(pageName);
        }
        function toggleBgPanel(page) {
            const panel = document.getElementById(page + '-bg-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }
        function changeBackground(page) {
            const input = document.getElementById(page + '-bg-input');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const bgLayer = document.getElementById(page + '-bg-layer');
                    bgLayer.style.backgroundImage = `url('${e.target.result}')`;
                    localStorage.setItem(page + '_bg', e.target.result);
                    document.getElementById(page + '-bg-panel').style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function loadBackground(page) {
            const savedBg = localStorage.getItem(page + '_bg');
            if (savedBg) {
                document.getElementById(page + '-bg-layer').style.backgroundImage = `url('${savedBg}')`;
            }
        }

        // ==================== åœ°åœ–åŠŸèƒ½ ====================
        // â˜… åœ°åœ–APIé‡‘é‘° - å¿…é ˆæ›¿æ›
        // å‰å¾€ https://console.cloud.google.com å•Ÿç”¨ Maps JavaScript API å’Œ Places API
        // å°‡ä¸‹æ–¹çš„ 'YOUR_GOOGLE_MAPS_API_KEY' æ›¿æ›ç‚ºä½ è‡ªå·±çš„é‡‘é‘°
        function initMap() {
            const defaultCenter = { lat: 13.7563, lng: 100.5018 };
            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultCenter,
                zoom: 12,
                styles: [
                    { featureType: "all", elementType: "geometry", stylers: [{ color: "#f5f5f5" }] },
                    { featureType: "water", elementType: "geometry", stylers: [{ color: "#c3d7df" }] }
                ]
            });
        }
        function updateMapPage() {
            if (!map) return;
            markers.forEach(m => m.setMap(null)); infoWindows.forEach(iw => iw.close());
            markers = []; infoWindows = [];
            const locationsList = document.getElementById('locations-list');
            locationsList.innerHTML = '';
            if (activities.length === 0) {
                locationsList.innerHTML = '<p style="color: var(--text-light); text-align: center; margin-top: 20px;">å°šæœªæ·»åŠ ä»»ä½•åœ°é»</p>';
                return;
            }
            const bounds = new google.maps.LatLngBounds();
            activities.forEach((activity, index) => {
                if (!activity.location || activity.location.trim() === '') return;
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: activity.location }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const position = results[0].geometry.location;
                        const marker = new google.maps.Marker({
                            map, position, title: activity.title,
                            animation: google.maps.Animation.DROP,
                            label: { text: (index + 1).toString(), color: 'white', fontWeight: 'bold' },
                            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 14, fillColor: '#4b6cb7', fillOpacity: 1, strokeColor: 'white', strokeWeight: 2 }
                        });
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<div style="padding:12px; max-width:250px;">
                                        <h3 style="margin:0 0 8px 0; color:var(--primary);">${activity.title}</h3>
                                        <p style="margin:0 0 5px 0; font-size:14px; color:#666;">ğŸ“ ${activity.location}</p>
                                        ${activity.remarks ? `<p style="margin:0; font-size:14px;">ğŸ“ ${activity.remarks.substring(0, 50)}${activity.remarks.length > 50 ? '...' : ''}</p>` : ''}
                                      </div>`
                        });
                        marker.addListener('click', () => { infoWindows.forEach(iw => iw.close()); infoWindow.open(map, marker); });
                        markers.push(marker); infoWindows.push(infoWindow); bounds.extend(position);
                        const listItem = document.createElement('div');
                        listItem.className = 'location-list-item';
                        listItem.innerHTML = `<div style="font-weight: bold; color: #2c3e50;">${index + 1}. ${activity.title}</div>
                                              <div style="font-size: 14px; color: #666; margin-top: 5px;">ğŸ“ ${activity.location}</div>`;
                        listItem.addEventListener('click', () => {
                            map.panTo(position); map.setZoom(16);
                            infoWindows.forEach(iw => iw.close()); infoWindow.open(map, marker);
                            marker.setAnimation(google.maps.Animation.BOUNCE);
                            setTimeout(() => marker.setAnimation(null), 1500);
                        });
                        locationsList.appendChild(listItem);
                        if (markers.length === activities.filter(a => a.location && a.location.trim() !== '').length) {
                            map.fitBounds(bounds); if (map.getZoom() > 15) map.setZoom(15);
                        }
                    }
                });
            });
        }

        // ==================== è¡Œç¨‹è¦åŠƒåŠŸèƒ½ (æ—¥æœŸé¡¯ç¤ºé‚è¼¯å·²ä¿®æ”¹) ====================
        function addActivity() {
            const activity = document.getElementById('activity-input').value;
            const location = document.getElementById('location-input').value;
            const timeValue = document.getElementById('time-input').value; // å–å¾—æ—¥æœŸæ™‚é–“å€¼
            const remarks = document.getElementById('remarks-input').value;

            if (!activity || !location) { alert('è«‹å¡«å¯«æ´»å‹•åç¨±å’Œåœ°é»'); return; }

            // è¨ˆç®—é¡¯ç¤ºç”¨çš„è©³ç´°æ—¥æœŸå­—ä¸²
            let displayDate = 'æœªè¨­å®šæ—¥æœŸ';
            if (timeValue) {
                const dateObj = new Date(timeValue);
                displayDate = dateObj.toLocaleDateString('zh-TW', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                });
                // å¯é¸ï¼šåŠ ä¸Šæ™‚é–“
                // displayDate += ' ' + dateObj.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            }

            const activityObj = { 
                id: Date.now(), 
                title: activity, 
                location: location, 
                // å„²å­˜åŸå§‹æ™‚é–“å€¼ä¾›å¾ŒçºŒä½¿ç”¨
                time: timeValue,
                // å„²å­˜ç”¨æ–¼é¡¯ç¤ºçš„è©³ç´°æ—¥æœŸå­—ä¸²
                displayDate: displayDate,
                remarks: remarks 
            };
            activities.push(activityObj); 
            renderItinerary(); 
            updateMapPage(); 
            saveToLocalStorage();

            document.getElementById('activity-input').value = '';
            document.getElementById('location-input').value = '';
            document.getElementById('time-input').value = '';
            document.getElementById('remarks-input').value = '';

            alert('æ´»å‹•å·²æ–°å¢ï¼');
        }
        function deleteActivity(id) {
            const index = activities.findIndex(a => a.id === id);
            if (index !== -1) { activities.splice(index, 1); renderItinerary(); updateMapPage(); saveToLocalStorage(); }
        }
        function renderItinerary() {
            const listContainer = document.getElementById('itinerary-list');
            listContainer.innerHTML = '';
            if (activities.length === 0) {
                listContainer.innerHTML = '<div style="text-align:center; padding:30px; color:#666;">å°šæœªæ·»åŠ ä»»ä½•è¡Œç¨‹</div>';
                return;
            }

            // æŒ‰æ—¥æœŸåˆ†çµ„æ´»å‹• (ä½¿ç”¨é¡¯ç¤ºæ—¥æœŸ displayDate é€²è¡Œåˆ†çµ„)
            const activitiesByDate = {};
            activities.forEach(activity => {
                const dateKey = activity.displayDate || 'æœªè¨­å®šæ—¥æœŸ';
                if (!activitiesByDate[dateKey]) activitiesByDate[dateKey] = [];
                activitiesByDate[dateKey].push(activity);
            });

            // ç‚ºæ¯å€‹æ—¥æœŸåˆ†é…é¡è‰²
            Object.keys(activitiesByDate).forEach((dateKey, index) => {
                if (!dateColors[dateKey]) dateColors[dateKey] = colorPalette[index % colorPalette.length];
            });

            // æ¸²æŸ“æ¯å€‹æ—¥æœŸå€å¡Š
            Object.keys(activitiesByDate).forEach(dateKey => {
                const dateSection = document.createElement('div');
                dateSection.className = 'date-section';
                dateSection.style.backgroundColor = dateColors[dateKey];
                
                // æ—¥æœŸæ¨™é ­é¡¯ç¤ºè©³ç´°æ—¥æœŸ
                dateSection.innerHTML = `<div class="date-header">${dateKey}</div><div class="sortable-list" id="sortable-${dateKey.replace(/\s+/g, '-')}"></div>`;
                listContainer.appendChild(dateSection);
                const sortableList = dateSection.querySelector(`#sortable-${dateKey.replace(/\s+/g, '-')}`);
                
                activitiesByDate[dateKey].forEach(activity => {
                    sortableList.appendChild(createActivityElement(activity));
                });
                
                new Sortable(sortableList, { animation: 150, ghostClass: 'sortable-ghost', onEnd: () => saveToLocalStorage() });
            });
        }
        function createActivityElement(activity) {
            const div = document.createElement('div'); 
            div.className = 'itinerary-item'; 
            div.setAttribute('data-id', activity.id);
            div.innerHTML = `<div class="item-content">
                                <div class="item-header">
                                    <div class="item-title">${activity.title}</div>
                                </div>
                                <div class="item-location">ğŸ“ ${activity.location}</div>
                                ${activity.remarks ? `<div class="item-remarks">ğŸ“ ${activity.remarks}</div>` : ''}
                             </div>
                             <button class="delete-btn" onclick="deleteActivity(${activity.id})" title="åˆªé™¤"></button>`;
            return div;
        }

        // ==================== é ç®—è¦åŠƒåŠŸèƒ½ ====================
        const expenses = JSON.parse(localStorage.getItem('travelExpenses')) || [];
        function addExpense() {
            const name = document.getElementById('expense-name').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const category = document.getElementById('expense-category').value;
            const payment = document.getElementById('payment-method').value;
            if (!name || !amount || !category || !payment) { alert('è«‹å¡«å¯«æ‰€æœ‰è³‡è¨Š'); return; }
            const expense = { id: Date.now(), name, amount, category, payment, date: new Date().toISOString().split('T')[0] };
            expenses.push(expense); totalSpent += amount; updateBudgetDisplay(); renderExpenses(); saveExpensesToLocalStorage();
            document.getElementById('expense-name').value = ''; document.getElementById('expense-amount').value = '';
            document.getElementById('expense-category').value = ''; document.getElementById('payment-method').value = '';
            alert('èŠ±è²»å·²è¨˜éŒ„ï¼');
        }
        function deleteExpense(id) {
            const index = expenses.findIndex(exp => exp.id === id);
            if (index !== -1) { totalSpent -= expenses[index].amount; expenses.splice(index, 1); updateBudgetDisplay(); renderExpenses(); saveExpensesToLocalStorage(); }
        }
        function updateBudgetDisplay() {
            document.getElementById('total-spent').textContent = totalSpent;
            document.getElementById('remaining').textContent = totalBudget - totalSpent;
        }
        function renderExpenses() {
            const list = document.getElementById('expense-list'); list.innerHTML = '';
            if (expenses.length === 0) { list.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">å°šæœªè¨˜éŒ„ä»»ä½•èŠ±è²»</div>'; return; }
            expenses.forEach(expense => {
                const item = document.createElement('div'); item.className = 'budget-item';
                const categoryNames = { 'food':'é¤é£²', 'shopping':'è³¼ç‰©', 'leisure':'ä¼‘é–’å¨›æ¨‚' };
                const paymentNames = { 'credit':'ä¿¡ç”¨å¡', 'cash':'ç¾é‡‘' };
                item.innerHTML = `<div><div style="font-weight:bold;">${expense.name}</div><div style="font-size:14px;color:var(--text-light);">${paymentNames[expense.payment]} â€¢ ${expense.date}</div></div>
                                  <div style="display:flex; align-items:center; gap:15px;">
                                    <div style="padding:5px 12px; border-radius:20px; font-size:12px; font-weight:bold; 
                                         background:${expense.category==='food'?'#e1f5fe':expense.category==='shopping'?'#f3e5f5':'#e8f5e8'}; 
                                         color:${expense.category==='food'?'#0277bd':expense.category==='shopping'?'#7b1fa2':'#2e7d32'}">
                                        ${categoryNames[expense.category]}
                                    </div>
                                    <div style="font-weight:bold;color:#EA5455;font-size:20px;">${expense.amount} à¸¿</div>
                                    <button class="delete-btn" onclick="deleteExpense(${expense.id})" title="åˆªé™¤"></button>
                                  </div>`;
                list.appendChild(item);
            });
        }

        // ==================== ç­†è¨˜åŠŸèƒ½ ====================
        const diaryEntries = JSON.parse(localStorage.getItem('travelDiary')) || [];
        function addDiaryEntry() {
            const title = document.getElementById('diary-title').value;
            const content = document.getElementById('diary-content').value;
            const imageInput = document.getElementById('diary-image');
            if (!title || !content) { alert('è«‹å¡«å¯«æ¨™é¡Œå’Œå…§å®¹'); return; }
            const entry = { id: Date.now(), title, content, date: new Date().toLocaleString('zh-TW'), image: null };
            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { entry.image = e.target.result; diaryEntries.unshift(entry); renderDiaryEntries(); saveDiaryToLocalStorage(); resetDiaryForm(); alert('ç­†è¨˜å·²æ–°å¢ï¼'); };
                reader.readAsDataURL(imageInput.files[0]);
            } else { diaryEntries.unshift(entry); renderDiaryEntries(); saveDiaryToLocalStorage(); resetDiaryForm(); alert('ç­†è¨˜å·²æ–°å¢ï¼'); }
        }
        function deleteDiaryEntry(id) {
            const index = diaryEntries.findIndex(entry => entry.id === id);
            if (index !== -1) { diaryEntries.splice(index, 1); renderDiaryEntries(); saveDiaryToLocalStorage(); }
        }
        function renderDiaryEntries() {
            const list = document.getElementById('diary-list'); list.innerHTML = '';
            if (diaryEntries.length === 0) { list.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">å°šæœªæ’°å¯«ä»»ä½•ç­†è¨˜</div>'; return; }
            diaryEntries.forEach(entry => {
                const entryEl = document.createElement('div'); entryEl.className = 'diary-entry';
                let imageHTML = ''; if (entry.image) { imageHTML = `<img src="${entry.image}" alt="ç­†è¨˜åœ–ç‰‡" style="max-width:100%; border-radius:var(--radius-sm); margin-top:15px;">`; }
                entryEl.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                        <div style="flex-grow:1;">
                                            <div style="font-weight:bold;font-size:20px;margin-bottom:10px;color:var(--dark);">${entry.title}</div>
                                            <div style="font-size:14px; color:#7f8c8d;">ğŸ“… ${entry.date}</div>
                                        </div>
                                        <button class="delete-btn" onclick="deleteDiaryEntry(${entry.id})" title="åˆªé™¤"></button>
                                     </div>
                                     <div style="margin-top:15px; line-height:1.8;">${entry.content.replace(/\n/g, '<br>')}</div>
                                     ${imageHTML}`;
                list.appendChild(entryEl);
            });
        }
        function resetDiaryForm() {
            document.getElementById('diary-title').value = '';
            document.getElementById('diary-content').value = '';
            document.getElementById('diary-image').value = '';
        }

        // ==================== æœ¬åœ°å„²å­˜åŠŸèƒ½ ====================
        function saveToLocalStorage() { localStorage.setItem('travelActivities', JSON.stringify(activities)); localStorage.setItem('dateColors', JSON.stringify(dateColors)); }
        function saveExpensesToLocalStorage() { localStorage.setItem('travelExpenses', JSON.stringify(expenses)); }
        function saveDiaryToLocalStorage() { localStorage.setItem('travelDiary', JSON.stringify(diaryEntries)); }
        function loadFromLocalStorage() {
            const savedActivities = localStorage.getItem('travelActivities');
            if (savedActivities) { activities.length = 0; activities.push(...JSON.parse(savedActivities)); renderItinerary(); }
            const savedExpenses = localStorage.getItem('travelExpenses');
            if (savedExpenses) { expenses.length = 0; expenses.push(...JSON.parse(savedExpenses)); expenses.forEach(exp => totalSpent += exp.amount); updateBudgetDisplay(); renderExpenses(); }
            const savedDiary = localStorage.getItem('travelDiary');
            if (savedDiary) { diaryEntries.length = 0; diaryEntries.push(...JSON.parse(savedDiary)); renderDiaryEntries(); }
            ['itinerary', 'map', 'budget', 'diary'].forEach(page => loadBackground(page));
        }

        // ==================== é é¢åˆå§‹åŒ– ====================
        window.onload = function() {
            loadFromLocalStorage();
            renderItinerary(); updateBudgetDisplay(); renderExpenses(); renderDiaryEntries();
            console.log('é é¢åˆå§‹åŒ–å®Œæˆã€‚è«‹æ›¿æ›åœ°åœ–APIé‡‘é‘°ã€‚');
        };
    </script>
</body>
</html>
