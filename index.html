<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的旅行規劃</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ★ Google Maps API - 必須替換為您的API金鑰 ★ -->
    <!-- 前往 https://console.cloud.google.com 啟用 Maps JavaScript API 和 Directions API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPr1fdJUrgy-b4lMzy_Zb8W-ihMY_Or9U&libraries=places,directions&callback=initMap" async defer></script>
    
    <style>
        :root {
            /* 使用提供的調色板 1: https://colorhunt.co/palette/ebf4dd90ab8b5a78633b4953 */
            --primary: #3B4953; /* 深藍灰色 */
            --secondary: #5A7863; /* 墨綠色 */
            --accent: #90AB8B; /* 柔和綠色 */
            --light: #EBF4DD; /* 淺米黃色 */
            --dark: #3B4953; /* 深藍灰色 */
            --text: #333333; /* 深灰色文字 */
            --text-light: #666666; /* 淺灰色文字 */
            --shadow: rgba(90, 120, 99, 0.15); /* 基於墨綠色的陰影 */
            --radius: 16px; /* 圓角大小 */
            --radius-sm: 10px; /* 小圓角 */
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: -apple-system, 'Microsoft JhengHei', 'PingFang TC', sans-serif; 
        }
        
        body { 
            background-color: var(--light); 
            color: var(--text); 
            min-height: 100vh; 
            padding-bottom: 90px; 
            line-height: 1.6; 
        }

        /* 可自訂的頁面背景 (應用於整個 .page) */
        .page-with-bg {
            position: relative;
            border-radius: var(--radius);
            overflow: hidden; /* 確保背景圖不溢出圓角 */
            box-shadow: 0 10px 30px var(--shadow);
            border: 1px solid rgba(90, 120, 99, 0.08);
            margin-bottom: 20px;
        }
        
        .page-bg-layer {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.6; /* 背景圖透明度 60% */
            z-index: 1;
        }
        
        .page-content {
            position: relative; /* 確保內容在背景圖上方 */
            z-index: 2;
            padding: 25px;
            background: rgba(255, 255, 255, 0.85); /* 內容區輕微白色背景，提高文字可讀性 */
            border-radius: var(--radius);
        }

        /* 背景設定按鈕 */
        .bg-setting-btn {
            position: absolute; 
            top: 15px; 
            right: 15px;
            background: rgba(255, 255, 255, 0.9); 
            border: none; 
            width: 36px; 
            height: 36px;
            border-radius: 50%; 
            font-size: 18px;
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); 
            transition: all 0.3s; 
            z-index: 3; /* 確保在最上層 */
        }
        
        .bg-setting-btn:hover { 
            background: white; 
            transform: scale(1.1); 
        }
        
        /* 背景設定面板 */
        .bg-setting-panel {
            display: none; 
            position: absolute; 
            top: 60px; 
            right: 15px;
            background: white; 
            padding: 20px; 
            border-radius: var(--radius-sm);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); 
            z-index: 4; 
            min-width: 250px;
            border: 1px solid rgba(90, 120, 99, 0.1);
        }
        
        .bg-setting-panel h4 { 
            margin-bottom: 10px; 
            color: var(--dark); 
        }
        
        .bg-setting-panel input[type="file"] { 
            width: 100%; 
            margin-bottom: 15px; 
            padding: 10px; 
            border: 1px dashed #ccc; 
            border-radius: 8px; 
        }
        
        .bg-setting-panel button { 
            background: var(--accent); 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 8px; 
            cursor: pointer; 
            width: 100%; 
        }

        /* 主內容區 */
        .main-content { 
            padding: 20px 15px; 
        }
        
        .page { 
            display: none; 
            margin-top: 20px; 
        } 
        
        .page.active { 
            display: block; 
            animation: fadeIn 0.5s ease; 
        }
        
        @keyframes fadeIn { 
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }

        /* 標題框 - 置中，與下方保持2cm距離 */
        .header-title-container {
            text-align: center;
            margin: 0 auto 1.5cm; /* 下邊距 1.5cm */
            display: flex;
            justify-content: center;
            padding: 0 15px;
        }
        
        .title-container {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            padding: 15px 25px;
            border-radius: 50px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            color: white;
            box-shadow: 0 6px 20px var(--shadow);
            max-width: 90%;
        }
        
        #app-title {
            font-size: 24px;
            font-weight: 700;
            border: none;
            background: transparent;
            color: white;
            text-align: center;
            outline: none;
            min-width: 180px;
            cursor: pointer;
            width: 100%;
        }

        h2 { 
            color: var(--dark); 
            margin-bottom: 20px; 
            padding-bottom: 12px; 
            border-bottom: 2px solid rgba(144, 171, 139, 0.3); 
            font-size: 22px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }

        /* 表單 */
        .input-group { 
            margin-bottom: 25px; 
        }
        
        input, textarea, select {
            width: 100%; 
            padding: 14px 18px; 
            margin: 8px 0; 
            border: 2px solid rgba(144, 171, 139, 0.3);
            border-radius: var(--radius-sm); 
            font-size: 16px; 
            transition: all 0.3s; 
            background: white;
            color: var(--text);
        }
        
        /* 特別為所有輸入框添加統一樣式 */
        input::placeholder, textarea::placeholder {
            color: #999;
        }
        
        input:focus, textarea:focus, select:focus { 
            outline: none; 
            border-color: var(--accent); 
            background: white; 
            box-shadow: 0 0 0 3px rgba(144, 171, 139, 0.2); 
        }
        
        /* 特別為日期輸入框調整，使其與其他輸入框邊框大小一致 */
        input[type="datetime-local"], input[type="date"] {
            padding: 14px 18px !important;
            border: 2px solid rgba(144, 171, 139, 0.3) !important;
            border-radius: var(--radius-sm) !important;
            font-size: 16px !important;
            color: var(--text) !important;
            background: white !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }
        
        /* 日期輸入框的描述標籤 */
        .date-label {
            display: block;
            margin-top: 8px;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--secondary);
            font-size: 15px;
        }
        
        button.primary-btn {
            background: linear-gradient(to right, var(--secondary), var(--accent)); 
            color: white; 
            border: none;
            padding: 16px 28px; 
            border-radius: var(--radius-sm); 
            font-size: 16px; 
            font-weight: 600;
            cursor: pointer; 
            transition: all 0.3s; 
            margin-top: 15px; 
            width: 100%; 
            letter-spacing: 0.5px;
        }
        
        button.primary-btn:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 10px 20px rgba(90, 120, 99, 0.3); 
        }

        /* 底部導航 */
        .bottom-nav {
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background: white;
            display: flex; 
            justify-content: space-around; 
            padding: 15px 0;
            box-shadow: 0 -5px 25px var(--shadow); 
            z-index: 1000; 
            border-top: 1px solid rgba(90, 120, 99, 0.1);
        }
        
        .nav-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            cursor: pointer; 
            padding: 10px 15px; 
            border-radius: var(--radius-sm); 
            transition: all 0.3s; 
            color: var(--text-light); 
            flex: 1;
            max-width: 80px;
        }
        
        .nav-item.active { 
            background: rgba(144, 171, 139, 0.1); 
            color: var(--secondary); 
        }
        
        .nav-icon { 
            font-size: 22px; 
            margin-bottom: 5px; 
        }
        
        .nav-text { 
            font-size: 12px; 
            font-weight: 500; 
        }

        /* 行程列表樣式 */
        #itinerary-list { 
            margin-top: 20px; 
        }
        
        .date-section { 
            margin-bottom: 25px; 
            background: rgba(235, 244, 221, 0.7); 
            border-radius: var(--radius); 
            padding: 20px; 
            border-left: 6px solid var(--accent); 
        }
        
        .date-header { 
            font-size: 18px; 
            font-weight: 700; 
            color: var(--dark); 
            margin-bottom: 15px; 
            padding-bottom: 8px; 
            border-bottom: 1px dashed rgba(90, 120, 99, 0.3); 
        }
        
        .sortable-list { 
            min-height: 20px; 
        }
        
        .itinerary-item {
            background: white; 
            border-radius: var(--radius-sm); 
            padding: 18px; 
            margin-bottom: 12px;
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); 
            border: 1px solid rgba(144, 171, 139, 0.2);
            transition: all 0.3s; 
            cursor: move;
        }
        
        .itinerary-item:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 20px rgba(90, 120, 99, 0.15); 
        }
        
        .item-content { 
            flex-grow: 1; 
        }
        
        .item-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 10px; 
        }
        
        .item-title { 
            font-weight: 700; 
            color: var(--text); 
            font-size: 17px; 
        }
        
        .item-time { 
            color: var(--secondary); 
            font-size: 14px; 
            font-weight: 600; 
            background: rgba(144, 171, 139, 0.1); 
            padding: 4px 10px; 
            border-radius: 20px; 
        }
        
        .item-location { 
            color: var(--text-light); 
            margin: 6px 0; 
            font-size: 14px; 
        }
        
        .item-remarks { 
            color: var(--text); 
            margin-top: 8px; 
            padding: 10px; 
            background: rgba(144, 171, 139, 0.08); 
            border-radius: 8px; 
            font-size: 14px; 
            border-left: 3px solid var(--accent); 
        }
        
        /* 新增：交通時間顯示 */
        .travel-time {
            display: inline-block;
            margin-top: 6px;
            padding: 4px 10px;
            background-color: rgba(144, 171, 139, 0.15);
            border-radius: 15px;
            font-size: 12px;
            color: var(--secondary);
            font-weight: 500;
        }
        
        .travel-time i {
            margin-right: 5px;
            color: var(--secondary);
        }

        /* 刪除按鈕 - 使用Font Awesome垃圾桶圖示 */
        .delete-btn {
            background: none;
            border: none; 
            width: 28px; 
            height: 28px; 
            cursor: pointer; 
            margin-left: 15px; 
            flex-shrink: 0;
            transition: all 0.3s; 
            opacity: 0.7;
            color: #EA5455;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .delete-btn:hover { 
            opacity: 1; 
            transform: scale(1.1); 
        }

        /* 記帳項目樣式 */
        .account-item {
            background: white; 
            border-radius: var(--radius-sm); 
            padding: 18px; 
            margin-bottom: 15px;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); 
            border: 1px solid rgba(144, 171, 139, 0.2);
        }

        /* 頁面內容 - 用於新頁面顯示 */
        .page-wrapper {
            display: none;
            padding: 20px 15px;
            animation: fadeIn 0.5s ease;
        }
        
        .page-wrapper.active {
            display: block;
        }
        
        /* 旅程簡介頁面樣式 */
        .trip-section {
            background: white;
            border-radius: var(--radius-sm);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--secondary);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(144, 171, 139, 0.1);
        }
        
        .section-icon {
            font-size: 24px;
            margin-right: 12px;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(144, 171, 139, 0.1);
            border-radius: 50%;
            color: var(--secondary);
        }
        
        .section-title {
            font-size: 20px;
            color: var(--dark);
            font-weight: 700;
        }
        
        .boarding-pass {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }
        
        .boarding-pass:before {
            content: "";
            position: absolute;
            top: 0;
            left: 30%;
            width: 40%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transform: skewX(-15deg);
        }
        
        .pass-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .pass-airline {
            font-size: 22px;
            font-weight: 700;
        }
        
        .pass-flight {
            font-size: 16px;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
        }
        
        .pass-details {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .pass-from, .pass-to {
            text-align: center;
        }
        
        .pass-city {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .pass-airport {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .pass-plane {
            font-size: 28px;
            text-align: center;
        }
        
        .pass-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        
        .pass-info-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
        }
        
        .info-label {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-size: 15px;
            font-weight: 600;
        }
        
        .hotel-card, .car-card {
            background: white;
            border-radius: var(--radius-sm);
            padding: 18px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(144, 171, 139, 0.1);
        }
        
        .hotel-name, .car-company {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }
        
        .hotel-address, .car-location {
            color: var(--text-light);
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .hotel-remarks, .car-remarks {
            padding: 12px;
            background-color: rgba(144, 171, 139, 0.08);
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
            border-left: 3px solid var(--accent);
        }
        
        .car-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }
        
        .car-detail-item {
            padding: 8px;
            background-color: rgba(144, 171, 139, 0.05);
            border-radius: 8px;
        }
        
        .other-info-item {
            background: white;
            border-radius: var(--radius-sm);
            padding: 18px;
            margin-bottom: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .other-title {
            font-size: 17px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }
        
        .other-content {
            color: var(--text);
            line-height: 1.6;
            font-size: 14px;
        }
        
        .edit-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 7px 14px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-btn:hover {
            background: var(--secondary);
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #888;
            background-color: rgba(144, 171, 139, 0.05);
            border-radius: var(--radius-sm);
        }
        
        .empty-state i {
            font-size: 40px;
            margin-bottom: 12px;
            color: #ccc;
        }
        
        /* 地圖容器 */
        #map-container {
            height: 350px;
            width: 100%;
            border-radius: var(--radius-sm);
            overflow: hidden;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        /* 模態框樣式 */
        .modal {
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 10000; 
            align-items: center; 
            justify-content: center;
            padding: 15px;
        }
        
        .modal-content {
            background: white; 
            width: 100%; 
            max-width: 500px; 
            border-radius: var(--radius); 
            padding: 25px; 
            max-height: 85vh; 
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            .header-title-container {
                margin-bottom: 1cm;
            }
            
            .title-container {
                padding: 12px 20px;
            }
            
            #app-title {
                font-size: 20px;
                min-width: 160px;
            }
            
            h2 {
                font-size: 20px;
            }
            
            .page-content {
                padding: 20px;
            }
            
            .pass-details {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .pass-plane {
                display: none;
            }
            
            .pass-info {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .car-details {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 20px;
            }
            
            .section-icon {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
            
            .section-title {
                font-size: 18px;
            }
        }
        
        @media (max-width: 480px) {
            .header-title-container {
                margin-bottom: 0.8cm;
            }
            
            .title-container {
                padding: 10px 15px;
                max-width: 95%;
            }
            
            #app-title {
                font-size: 18px;
            }
            
            h2 {
                font-size: 18px;
            }
            
            .page-content {
                padding: 15px;
            }
            
            .pass-info {
                grid-template-columns: 1fr;
            }
            
            .bottom-nav {
                padding: 12px 0;
            }
            
            .nav-item {
                padding: 8px 10px;
            }
            
            .nav-icon {
                font-size: 20px;
            }
            
            .nav-text {
                font-size: 11px;
            }
            
            .itinerary-item {
                padding: 15px;
            }
        }
        
        /* 工具類 */
        .mt-10 { margin-top: 10px; }
        .mt-15 { margin-top: 15px; }
        .mt-20 { margin-top: 20px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-15 { margin-bottom: 15px; }
        .mb-20 { margin-bottom: 20px; }
        .text-center { text-align: center; }
        .d-flex { display: flex; }
        .flex-column { flex-direction: column; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-10 { gap: 10px; }
        .gap-15 { gap: 15px; }
        .w-100 { width: 100%; }
        
        /* 載入動畫 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(144, 171, 139, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- 置中的標題框 -->
    <div class="header-title-container">
        <div class="title-container">
            <input type="text" id="app-title" value="✈️ 我的旅行規劃" maxlength="30" onclick="this.select();">
        </div>
    </div>

    <!-- 頁面1：行程規劃 -->
    <div id="itinerary-wrapper" class="page-wrapper active">
        <div id="itinerary-page" class="page-with-bg">
            <!-- 背景圖層與設定按鈕 -->
            <div id="itinerary-bg-layer" class="page-bg-layer"></div>
            <button class="bg-setting-btn" onclick="toggleBgPanel('itinerary')"><i class="fas fa-cog"></i></button>
            <div id="itinerary-bg-panel" class="bg-setting-panel">
                <h4>更改背景圖</h4>
                <input type="file" id="itinerary-bg-input" accept="image/*">
                <button onclick="changeBackground('itinerary')">套用背景</button>
            </div>
            <!-- 頁面主要內容 -->
            <div class="page-content">
                <h2><i class="fas fa-route"></i> 行程規劃</h2>
                <div class="input-group">
                    <input type="text" id="activity-input" placeholder="活動名稱">
                    <input type="text" id="location-input" placeholder="地點">
                    
                    <!-- 日期輸入框 - 帶有描述標籤 -->
                    <label class="date-label">日期</label>
                    <input type="datetime-local" id="time-input" placeholder="請選擇日期和時間">
                    
                    <textarea id="remarks-input" placeholder="備註" rows="3"></textarea>
                    <button class="primary-btn" onclick="addActivity()"><i class="fas fa-plus"></i> 新增活動</button>
                </div>
                <div id="itinerary-list"></div>
            </div>
        </div>
    </div>

    <!-- 頁面2：行程地圖 -->
    <div id="map-wrapper" class="page-wrapper">
        <div id="map-page" class="page-with-bg">
            <div id="map-bg-layer" class="page-bg-layer"></div>
            <button class="bg-setting-btn" onclick="toggleBgPanel('map')"><i class="fas fa-cog"></i></button>
            <div id="map-bg-panel" class="bg-setting-panel">
                <h4>更改背景圖</h4>
                <input type="file" id="map-bg-input" accept="image/*">
                <button onclick="changeBackground('map')">套用背景</button>
            </div>
            <div class="page-content">
                <h2><i class="fas fa-map-marked-alt"></i> 行程地圖</h2>
                <div id="map-container">
                    <div id="map"></div>
                </div>
                <div id="locations-list" class="mt-20">
                    <h3><i class="fas fa-list"></i> 行程地點列表</h3>
                    <div id="locations-container" class="mt-15">
                        <p style="color: var(--text-light); text-align: center; margin-top: 20px; padding: 20px; background: rgba(144, 171, 139, 0.08); border-radius: var(--radius-sm);">
                            <i class="fas fa-map-marker-alt"></i> 請先在行程頁面添加活動地點
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 頁面3：記帳功能 (原預算規劃) -->
    <div id="account-wrapper" class="page-wrapper">
        <div id="account-page" class="page-with-bg">
            <div id="account-bg-layer" class="page-bg-layer"></div>
            <button class="bg-setting-btn" onclick="toggleBgPanel('account')"><i class="fas fa-cog"></i></button>
            <div id="account-bg-panel" class="bg-setting-panel">
                <h4>更改背景圖</h4>
                <input type="file" id="account-bg-input" accept="image/*">
                <button onclick="changeBackground('account')">套用背景</button>
            </div>
            <div class="page-content">
                <h2><i class="fas fa-calculator"></i> 記帳功能</h2>
                <div class="input-group">
                    <input type="text" id="expense-name" placeholder="花費項目名稱">
                    <input type="number" id="expense-amount" placeholder="金額">
                    <select id="expense-category">
                        <option value="">選擇分類</option>
                        <option value="food">餐飲</option>
                        <option value="transportation">交通</option>
                        <option value="accommodation">住宿</option>
                        <option value="shopping">購物</option>
                        <option value="leisure">休閒娛樂</option>
                        <option value="other">其他</option>
                    </select>
                    <label class="date-label">日期</label>
                    <input type="date" id="expense-date" placeholder="請選擇日期">
                    <button class="primary-btn" onclick="addExpense()"><i class="fas fa-plus"></i> 記錄花費</button>
                </div>
                <div id="account-list"></div>
                <div style="text-align: center; padding: 20px; margin-top: 25px; background: rgba(144, 171, 139, 0.08); border-radius: var(--radius-sm);">
                    <h3><i class="fas fa-chart-bar"></i> 總支出統計</h3>
                    <div style="font-size: 28px; font-weight: 700; color: var(--secondary); margin: 12px 0;">
                        <span id="total-expense">0</span> 元
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 頁面4：旅行筆記 -->
    <div id="diary-wrapper" class="page-wrapper">
        <div id="diary-page" class="page-with-bg">
            <div id="diary-bg-layer" class="page-bg-layer"></div>
            <button class="bg-setting-btn" onclick="toggleBgPanel('diary')"><i class="fas fa-cog"></i></button>
            <div id="diary-bg-panel" class="bg-setting-panel">
                <h4>更改背景圖</h4>
                <input type="file" id="diary-bg-input" accept="image/*">
                <button onclick="changeBackground('diary')">套用背景</button>
            </div>
            <div class="page-content">
                <h2><i class="fas fa-book"></i> 旅行筆記</h2>
                <div class="input-group">
                    <input type="text" id="diary-title" placeholder="筆記標題">
                    <textarea id="diary-content" placeholder="寫下您的筆記..." rows="5"></textarea>
                    <input type="file" id="diary-image" accept="image/*">
                    <button class="primary-btn" onclick="addDiaryEntry()"><i class="fas fa-plus"></i> 新增筆記</button>
                </div>
                <div id="diary-list"></div>
            </div>
        </div>
    </div>

    <!-- 頁面5：旅程簡介 -->
    <div id="trip-wrapper" class="page-wrapper">
        <div id="trip-page" class="page-with-bg">
            <div id="trip-bg-layer" class="page-bg-layer"></div>
            <button class="bg-setting-btn" onclick="toggleBgPanel('trip')"><i class="fas fa-cog"></i></button>
            <div id="trip-bg-panel" class="bg-setting-panel">
                <h4>更改背景圖</h4>
                <input type="file" id="trip-bg-input" accept="image/*">
                <button onclick="changeBackground('trip')">套用背景</button>
            </div>
            <div class="page-content">
                <h2><i class="fas fa-info-circle"></i> 旅程簡介</h2>
                
                <!-- 航班資訊 -->
                <div class="trip-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-plane-departure"></i></div>
                        <div class="section-title">航班資訊</div>
                    </div>
                    <div id="flight-container">
                        <!-- 航班資訊將動態添加 -->
                        <div class="empty-state">
                            <i class="fas fa-plane"></i>
                            <p>尚未添加航班資訊</p>
                            <button class="edit-btn" onclick="editFlight()"><i class="fas fa-plus"></i> 添加航班資訊</button>
                        </div>
                    </div>
                </div>
                
                <!-- 酒店資訊 -->
                <div class="trip-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-hotel"></i></div>
                        <div class="section-title">酒店資訊</div>
                    </div>
                    <div id="hotel-container">
                        <!-- 酒店資訊將動態添加 -->
                        <div class="empty-state">
                            <i class="fas fa-bed"></i>
                            <p>尚未添加酒店資訊</p>
                            <button class="edit-btn" onclick="editHotel()"><i class="fas fa-plus"></i> 添加酒店資訊</button>
                        </div>
                    </div>
                </div>
                
                <!-- 租車資訊 -->
                <div class="trip-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-car"></i></div>
                        <div class="section-title">租車資訊</div>
                    </div>
                    <div id="car-container">
                        <!-- 租車資訊將動態添加 -->
                        <div class="empty-state">
                            <i class="fas fa-car-side"></i>
                            <p>尚未添加租車資訊</p>
                            <button class="edit-btn" onclick="editCar()"><i class="fas fa-plus"></i> 添加租車資訊</button>
                        </div>
                    </div>
                </div>
                
                <!-- 其他資訊 -->
                <div class="trip-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-info-circle"></i></div>
                        <div class="section-title">其他資訊</div>
                    </div>
                    <div id="other-container">
                        <!-- 其他資訊將動態添加 -->
                        <div class="empty-state">
                            <i class="fas fa-sticky-note"></i>
                            <p>尚未添加其他資訊</p>
                            <button class="edit-btn" onclick="editOther()"><i class="fas fa-plus"></i> 添加其他資訊</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部導航列 (新順序：行程->地圖->記帳->筆記->旅程簡介) -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="showPage('itinerary')">
            <div class="nav-icon"><i class="fas fa-route"></i></div>
            <div class="nav-text">行程</div>
        </div>
        <div class="nav-item" onclick="showPage('map')">
            <div class="nav-icon"><i class="fas fa-map-marked-alt"></i></div>
            <div class="nav-text">地圖</div>
        </div>
        <div class="nav-item" onclick="showPage('account')">
            <div class="nav-icon"><i class="fas fa-calculator"></i></div>
            <div class="nav-text">記帳</div>
        </div>
        <div class="nav-item" onclick="showPage('diary')">
            <div class="nav-icon"><i class="fas fa-book"></i></div>
            <div class="nav-text">筆記</div>
        </div>
        <div class="nav-item" onclick="showPage('trip')">
            <div class="nav-icon"><i class="fas fa-info-circle"></i></div>
            <div class="nav-text">簡介</div>
        </div>
    </div>

    <!-- 航班編輯模態框 -->
    <div id="flight-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom:20px;"><i class="fas fa-plane-departure"></i> 編輯航班資訊</h3>
            <div id="flight-form">
                <!-- 航班表單將動態生成 -->
            </div>
            <div style="display:flex; gap:15px; margin-top:25px;">
                <button class="primary-btn" onclick="saveFlight()" style="flex:1;"><i class="fas fa-save"></i> 儲存航班資訊</button>
                <button class="edit-btn" onclick="closeModal('flight-modal')" style="background:#6c757d; flex:1;"><i class="fas fa-times"></i> 取消</button>
            </div>
        </div>
    </div>

    <!-- 酒店編輯模態框 -->
    <div id="hotel-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom:20px;"><i class="fas fa-hotel"></i> 編輯酒店資訊</h3>
            <div class="input-group">
                <input type="text" id="hotel-name" placeholder="酒店名稱">
                <input type="text" id="hotel-address" placeholder="酒店地址">
                <label class="date-label">入住日期</label>
                <input type="date" id="hotel-checkin" placeholder="請選擇入住日期">
                <label class="date-label">退房日期</label>
                <input type="date" id="hotel-checkout" placeholder="請選擇退房日期">
                <textarea id="hotel-remarks-input" placeholder="備註" rows="3"></textarea>
            </div>
            <div style="display:flex; gap:15px; margin-top:25px;">
                <button class="primary-btn" onclick="saveHotel()"><i class="fas fa-save"></i> 儲存酒店資訊</button>
                <button class="edit-btn" onclick="closeModal('hotel-modal')" style="background:#6c757d;"><i class="fas fa-times"></i> 取消</button>
            </div>
        </div>
    </div>

    <!-- 租車編輯模態框 -->
    <div id="car-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom:20px;"><i class="fas fa-car"></i> 編輯租車資訊</h3>
            <div class="input-group">
                <input type="text" id="car-company" placeholder="租車公司">
                <input type="text" id="car-pickup-location" placeholder="取車地點">
                <input type="text" id="car-return-location" placeholder="還車地點">
                <label class="date-label">取車時間</label>
                <input type="datetime-local" id="car-pickup-time" placeholder="請選擇取車時間">
                <label class="date-label">還車時間</label>
                <input type="datetime-local" id="car-return-time" placeholder="請選擇還車時間">
                <textarea id="car-remarks-input" placeholder="備註" rows="3"></textarea>
            </div>
            <div style="display:flex; gap:15px; margin-top:25px;">
                <button class="primary-btn" onclick="saveCar()"><i class="fas fa-save"></i> 儲存租車資訊</button>
                <button class="edit-btn" onclick="closeModal('car-modal')" style="background:#6c757d;"><i class="fas fa-times"></i> 取消</button>
            </div>
        </div>
    </div>

    <!-- 其他資訊編輯模態框 -->
    <div id="other-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom:20px;"><i class="fas fa-info-circle"></i> 編輯其他資訊</h3>
            <div class="input-group">
                <input type="text" id="other-title-input" placeholder="標題">
                <textarea id="other-content-input" placeholder="內容" rows="5"></textarea>
            </div>
            <div style="display:flex; gap:15px; margin-top:25px;">
                <button class="primary-btn" onclick="saveOther()"><i class="fas fa-save"></i> 儲存資訊</button>
                <button class="edit-btn" onclick="closeModal('other-modal')" style="background:#6c757d;"><i class="fas fa-times"></i> 取消</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== 全域變數 ====================
        let totalExpense = 0;
        const activities = []; 
        const dateColors = {};
        const expenses = JSON.parse(localStorage.getItem('travelExpenses')) || [];
        const diaryEntries = JSON.parse(localStorage.getItem('travelDiary')) || [];
        const colorPalette = [ 
            'rgba(144, 171, 139, 0.15)', 
            'rgba(90, 120, 99, 0.15)', 
            'rgba(59, 73, 83, 0.1)', 
            'rgba(235, 244, 221, 0.5)' 
        ];
        
        // 旅程簡介數據
        let tripInfo = JSON.parse(localStorage.getItem('tripInfo')) || {
            flights: [],
            hotels: [],
            cars: [],
            others: []
        };
        
        // Google Maps 相關變數
        let map;
        let markers = [];
        let directionsService;
        let directionsRenderer;

        // ==================== 頁面切換功能 ====================
        function showPage(pageName) {
            // 隱藏所有頁面
            document.querySelectorAll('.page-wrapper').forEach(wrapper => {
                wrapper.classList.remove('active');
            });
            
            // 顯示選中的頁面
            document.getElementById(pageName + '-wrapper').classList.add('active');
            
            // 更新導航選中狀態
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // 更新頁面標題
            const pageTitles = {
                'itinerary': '行程規劃',
                'map': '行程地圖',
                'account': '記帳功能',
                'diary': '旅行筆記',
                'trip': '旅程簡介'
            };
            
            // 更新瀏覽器歷史記錄
            history.pushState({page: pageName}, '', `#${pageName}`);
            
            // 加載該頁面的背景
            loadBackground(pageName);
            
            // 如果是記帳頁面，更新總支出
            if (pageName === 'account') {
                updateExpenseTotal();
            }
            
            // 如果是地圖頁面，初始化地圖
            if (pageName === 'map') {
                setTimeout(() => {
                    if (!map) {
                        initMap();
                    } else {
                        updateMap();
                    }
                }, 100);
            }
            
            // 如果是旅程簡介頁面，渲染內容
            if (pageName === 'trip') {
                renderTripInfo();
            }
        }

        // 處理瀏覽器後退/前進按鈕
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.page) {
                const pageName = event.state.page;
                document.querySelectorAll('.page-wrapper').forEach(wrapper => {
                    wrapper.classList.remove('active');
                });
                document.getElementById(pageName + '-wrapper').classList.add('active');
                
                // 更新導航選中狀態
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('onclick') === `showPage('${pageName}')`) {
                        item.classList.add('active');
                    }
                });
                
                loadBackground(pageName);
            }
        });

        // 頁面載入時檢查URL中的hash
        window.addEventListener('load', function() {
            const hash = window.location.hash.substring(1);
            const validPages = ['itinerary', 'map', 'account', 'diary', 'trip'];
            
            if (hash && validPages.includes(hash)) {
                // 顯示對應頁面
                document.querySelectorAll('.page-wrapper').forEach(wrapper => {
                    wrapper.classList.remove('active');
                });
                document.getElementById(hash + '-wrapper').classList.add('active');
                
                // 更新導航選中狀態
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('onclick') === `showPage('${hash}')`) {
                        item.classList.add('active');
                    }
                });
            }
        });

        // ==================== 背景控制功能 ====================
        function toggleBgPanel(page) {
            const panel = document.getElementById(page + '-bg-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }
        
        function changeBackground(page) {
            const input = document.getElementById(page + '-bg-input');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const bgLayer = document.getElementById(page + '-bg-layer');
                    bgLayer.style.backgroundImage = `url('${e.target.result}')`;
                    localStorage.setItem(page + '_bg', e.target.result);
                    document.getElementById(page + '-bg-panel').style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function loadBackground(page) {
            const savedBg = localStorage.getItem(page + '_bg');
            if (savedBg) {
                document.getElementById(page + '-bg-layer').style.backgroundImage = `url('${savedBg}')`;
            }
        }

        // ==================== 行程規劃功能 ====================
        function addActivity() {
            const activity = document.getElementById('activity-input').value;
            const location = document.getElementById('location-input').value;
            const timeValue = document.getElementById('time-input').value;
            const remarks = document.getElementById('remarks-input').value;

            if (!activity || !location) { 
                alert('請填寫活動名稱和地點'); 
                return; 
            }

            let displayDate = '未設定日期';
            if (timeValue) {
                const dateObj = new Date(timeValue);
                displayDate = dateObj.toLocaleDateString('zh-TW', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                });
            }

            const activityObj = { 
                id: Date.now(), 
                title: activity, 
                location: location, 
                time: timeValue,
                displayDate: displayDate,
                remarks: remarks,
                travelTime: null // 儲存交通時間
            };
            
            activities.push(activityObj); 
            renderItinerary(); 
            updateMapLocations(); 
            saveToLocalStorage();
            
            // 計算交通時間
            calculateTravelTimes();

            document.getElementById('activity-input').value = '';
            document.getElementById('location-input').value = '';
            document.getElementById('time-input').value = '';
            document.getElementById('remarks-input').value = '';

            // 顯示成功提示
            showNotification('活動已新增！', 'success');
        }
        
        function deleteActivity(id) {
            const index = activities.findIndex(a => a.id === id);
            if (index !== -1) { 
                activities.splice(index, 1); 
                renderItinerary(); 
                updateMapLocations(); 
                saveToLocalStorage(); 
                
                // 重新計算交通時間
                calculateTravelTimes();
                
                // 顯示成功提示
                showNotification('活動已刪除', 'info');
            }
        }
        
        function renderItinerary() {
            const listContainer = document.getElementById('itinerary-list');
            listContainer.innerHTML = '';
            
            if (activities.length === 0) {
                listContainer.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-plus"></i><p>尚未添加任何行程</p></div>';
                return;
            }

            // 按日期分組活動
            const activitiesByDate = {};
            activities.forEach(activity => {
                const dateKey = activity.displayDate || '未設定日期';
                if (!activitiesByDate[dateKey]) activitiesByDate[dateKey] = [];
                activitiesByDate[dateKey].push(activity);
            });

            // 為每個日期分配顏色
            Object.keys(activitiesByDate).forEach((dateKey, index) => {
                if (!dateColors[dateKey]) dateColors[dateKey] = colorPalette[index % colorPalette.length];
            });

            // 渲染每個日期區塊
            Object.keys(activitiesByDate).forEach(dateKey => {
                const dateSection = document.createElement('div');
                dateSection.className = 'date-section';
                dateSection.style.backgroundColor = dateColors[dateKey];
                
                dateSection.innerHTML = `<div class="date-header">${dateKey}</div><div class="sortable-list" id="sortable-${dateKey.replace(/\s+/g, '-')}"></div>`;
                listContainer.appendChild(dateSection);
                const sortableList = dateSection.querySelector(`#sortable-${dateKey.replace(/\s+/g, '-')}`);
                
                activitiesByDate[dateKey].forEach(activity => {
                    sortableList.appendChild(createActivityElement(activity));
                });
                
                // 排序結束時重新計算交通時間
                new Sortable(sortableList, { 
                    animation: 150, 
                    ghostClass: 'sortable-ghost', 
                    onEnd: function() {
                        saveToLocalStorage();
                        calculateTravelTimes();
                    }
                });
            });
        }
        
        function createActivityElement(activity) {
            const div = document.createElement('div'); 
            div.className = 'itinerary-item'; 
            div.setAttribute('data-id', activity.id);
            
            // 交通時間顯示
            let travelTimeHtml = '';
            if (activity.travelTime) {
                travelTimeHtml = `<div class="travel-time"><i class="fas fa-car"></i> 預計交通時間: ${activity.travelTime}</div>`;
            }
            
            div.innerHTML = `<div class="item-content">
                                <div class="item-header">
                                    <div class="item-title">${activity.title}</div>
                                    <div class="item-time">${activity.displayDate}</div>
                                </div>
                                <div class="item-location"><i class="fas fa-map-marker-alt"></i> ${activity.location}</div>
                                ${travelTimeHtml}
                                ${activity.remarks ? `<div class="item-remarks"><i class="fas fa-sticky-note"></i> ${activity.remarks}</div>` : ''}
                             </div>
                             <button class="delete-btn" onclick="deleteActivity(${activity.id})" title="刪除"><i class="fas fa-trash"></i></button>`;
            return div;
        }

        // ==================== Google Maps 相關功能 ====================
        function initMap() {
            // ★ 設置默認中心點為曼谷 (Bangkok) ★
            const defaultCenter = { lat: 13.7563, lng: 100.5018 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultCenter,
                zoom: 12,
                styles: [
                    {
                        featureType: "all",
                        elementType: "geometry",
                        stylers: [{ color: "#f5f5f5" }]
                    },
                    {
                        featureType: "water",
                        elementType: "geometry",
                        stylers: [{ color: "#c3d7df" }]
                    }
                ]
            });
            
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);
            
            updateMap();
        }
        
        function updateMap() {
            if (!map) return;
            
            // 清除現有標記
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            // 添加活動地點標記
            activities.forEach((activity, index) => {
                if (!activity.location || activity.location.trim() === '') return;
                
                // 使用Geocoder將地址轉換為座標
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: activity.location }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const position = results[0].geometry.location;
                        
                        const marker = new google.maps.Marker({
                            map: map,
                            position: position,
                            title: activity.title,
                            label: {
                                text: (index + 1).toString(),
                                color: 'white',
                                fontWeight: 'bold'
                            },
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 14,
                                fillColor: '#5A7863',
                                fillOpacity: 1,
                                strokeColor: 'white',
                                strokeWeight: 2
                            }
                        });
                        
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<div style="padding:12px; max-width:250px;">
                                        <h3 style="margin:0 0 8px 0; color:#5A7863;">${activity.title}</h3>
                                        <p style="margin:0 0 5px 0; font-size:14px; color:#666;"><i class="fas fa-map-marker-alt"></i> ${activity.location}</p>
                                        ${activity.displayDate ? `<p style="margin:0 0 5px 0; font-size:14px;"><i class="fas fa-calendar"></i> ${activity.displayDate}</p>` : ''}
                                        ${activity.travelTime ? `<p style="margin:0 0 5px 0; font-size:14px;"><i class="fas fa-car"></i> ${activity.travelTime}</p>` : ''}
                                        ${activity.remarks ? `<p style="margin:0; font-size:14px;"><i class="fas fa-sticky-note"></i> ${activity.remarks.substring(0, 50)}${activity.remarks.length > 50 ? '...' : ''}</p>` : ''}
                                      </div>`
                        });
                        
                        marker.addListener('click', () => {
                            infoWindow.open(map, marker);
                        });
                        
                        markers.push(marker);
                    }
                });
            });
            
            // 添加酒店標記
            tripInfo.hotels.forEach((hotel, index) => {
                if (!hotel.address || hotel.address.trim() === '') return;
                
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: hotel.address }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const position = results[0].geometry.location;
                        
                        const marker = new google.maps.Marker({
                            map: map,
                            position: position,
                            title: hotel.name,
                            icon: {
                                url: "https://maps.google.com/mapfiles/ms/icons/lodging.png",
                                scaledSize: new google.maps.Size(32, 32)
                            }
                        });
                        
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<div style="padding:12px; max-width:250px;">
                                        <h3 style="margin:0 0 8px 0; color:#5A7863;"><i class="fas fa-hotel"></i> ${hotel.name}</h3>
                                        <p style="margin:0 0 5px 0; font-size:14px; color:#666;"><i class="fas fa-map-marker-alt"></i> ${hotel.address}</p>
                                        ${hotel.checkin ? `<p style="margin:0 0 5px 0; font-size:14px;"><i class="fas fa-calendar-check"></i> 入住: ${hotel.checkin}</p>` : ''}
                                        ${hotel.checkout ? `<p style="margin:0 0 5px 0; font-size:14px;"><i class="fas fa-calendar-times"></i> 退房: ${hotel.checkout}</p>` : ''}
                                        ${hotel.remarks ? `<p style="margin:0; font-size:14px;"><i class="fas fa-sticky-note"></i> ${hotel.remarks.substring(0, 50)}${hotel.remarks.length > 50 ? '...' : ''}</p>` : ''}
                                      </div>`
                        });
                        
                        marker.addListener('click', () => {
                            infoWindow.open(map, marker);
                        });
                        
                        markers.push(marker);
                    }
                });
            });
            
            // 添加租車地點標記
            tripInfo.cars.forEach((car, index) => {
                if (!car.pickupLocation || car.pickupLocation.trim() === '') return;
                
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: car.pickupLocation }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const position = results[0].geometry.location;
                        
                        const marker = new google.maps.Marker({
                            map: map,
                            position: position,
                            title: `${car.company} - 取車點`,
                            icon: {
                                url: "https://maps.google.com/mapfiles/ms/icons/car.png",
                                scaledSize: new google.maps.Size(32, 32)
                            }
                        });
                        
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<div style="padding:12px; max-width:250px;">
                                        <h3 style="margin:0 0 8px 0; color:#5A7863;"><i class="fas fa-car"></i> ${car.company}</h3>
                                        <p style="margin:0 0 5px 0; font-size:14px; color:#666;"><i class="fas fa-map-marker-alt"></i> 取車: ${car.pickupLocation}</p>
                                        ${car.returnLocation ? `<p style="margin:0 0 5px 0; font-size:14px;"><i class="fas fa-map-marker-alt"></i> 還車: ${car.returnLocation}</p>` : ''}
                                        ${car.pickupTime ? `<p style="margin:0 0 5px 0; font-size:14px;"><i class="fas fa-calendar-check"></i> 取車時間: ${formatDateTime(car.pickupTime)}</p>` : ''}
                                        ${car.returnTime ? `<p style="margin:0 0 5px 0; font-size:14px;"><i class="fas fa-calendar-times"></i> 還車時間: ${formatDateTime(car.returnTime)}</p>` : ''}
                                        ${car.remarks ? `<p style="margin:0; font-size:14px;"><i class="fas fa-sticky-note"></i> ${car.remarks.substring(0, 50)}${car.remarks.length > 50 ? '...' : ''}</p>` : ''}
                                      </div>`
                        });
                        
                        marker.addListener('click', () => {
                            infoWindow.open(map, marker);
                        });
                        
                        markers.push(marker);
                    }
                });
            });
        }
        
        // 計算交通時間函數
        function calculateTravelTimes() {
            if (!directionsService || activities.length < 2) return;
            
            // 為每個活動計算從上一個地點到當前地點的交通時間
            for (let i = 1; i < activities.length; i++) {
                const prevActivity = activities[i - 1];
                const currentActivity = activities[i];
                
                if (!prevActivity.location || !currentActivity.location) continue;
                
                const request = {
                    origin: prevActivity.location,
                    destination: currentActivity.location,
                    travelMode: 'DRIVING',
                    drivingOptions: {
                        departureTime: new Date(),
                        trafficModel: 'bestguess'
                    }
                };
                
                directionsService.route(request, (result, status) => {
                    if (status === 'OK') {
                        const duration = result.routes[0].legs[0].duration.text;
                        currentActivity.travelTime = duration;
                        
                        // 更新顯示
                        renderItinerary();
                        saveToLocalStorage();
                    }
                });
            }
        }
        
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '';
            const date = new Date(dateTimeStr);
            return date.toLocaleString('zh-TW');
        }

        // ==================== 地圖頁面功能 ====================
        function updateMapLocations() {
            const locationsContainer = document.getElementById('locations-container');
            locationsContainer.innerHTML = '';
            
            if (activities.length === 0) {
                locationsContainer.innerHTML = '<div class="empty-state"><i class="fas fa-map-marker-alt"></i><p>請先在行程頁面添加活動地點</p></div>';
                return;
            }
            
            activities.forEach((activity, index) => {
                if (!activity.location || activity.location.trim() === '') return;
                
                const locationItem = document.createElement('div');
                locationItem.className = 'account-item';
                locationItem.style.cursor = 'default';
                
                let travelTimeHtml = '';
                if (activity.travelTime) {
                    travelTimeHtml = `<div style="margin-top: 8px;"><span style="background-color: rgba(144, 171, 139, 0.2); padding: 3px 8px; border-radius: 12px; font-size: 12px;"><i class="fas fa-car"></i> ${activity.travelTime}</span></div>`;
                }
                
                locationItem.innerHTML = `
                    <div>
                        <div style="font-weight:bold;">${index + 1}. ${activity.title}</div>
                        <div style="font-size:14px;color:var(--text-light);"><i class="fas fa-map-marker-alt"></i> ${activity.location}</div>
                        ${activity.displayDate ? `<div style="font-size:14px;color:var(--secondary); margin-top:5px;"><i class="fas fa-calendar"></i> ${activity.displayDate}</div>` : ''}
                        ${travelTimeHtml}
                    </div>
                    <div>
                        ${activity.remarks ? `<div style="background: rgba(144, 171, 139, 0.2); padding: 5px 12px; border-radius: 20px; font-size: 12px; color: var(--dark);"><i class="fas fa-sticky-note"></i> 有備註</div>` : ''}
                    </div>
                `;
                locationsContainer.appendChild(locationItem);
            });
        }

        // ==================== 記帳功能 ====================
        function addExpense() {
            const name = document.getElementById('expense-name').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const category = document.getElementById('expense-category').value;
            const date = document.getElementById('expense-date').value || new Date().toISOString().split('T')[0];
            
            if (!name || !amount || !category) { 
                alert('請填寫花費項目、金額和分類'); 
                return; 
            }
            
            const expense = { 
                id: Date.now(), 
                name, 
                amount, 
                category, 
                date,
                formattedDate: new Date(date).toLocaleDateString('zh-TW')
            };
            
            expenses.push(expense); 
            totalExpense += amount; 
            renderExpenses(); 
            updateExpenseTotal();
            saveExpensesToLocalStorage();
            
            document.getElementById('expense-name').value = '';
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-category').value = '';
            document.getElementById('expense-date').value = '';
            
            showNotification('花費已記錄！', 'success');
        }
        
        function deleteExpense(id) {
            const index = expenses.findIndex(exp => exp.id === id);
            if (index !== -1) { 
                totalExpense -= expenses[index].amount; 
                expenses.splice(index, 1); 
                renderExpenses(); 
                updateExpenseTotal();
                saveExpensesToLocalStorage(); 
                showNotification('支出記錄已刪除', 'info');
            }
        }
        
        function updateExpenseTotal() {
            totalExpense = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            document.getElementById('total-expense').textContent = totalExpense.toLocaleString();
        }
        
        function renderExpenses() {
            const list = document.getElementById('account-list'); 
            list.innerHTML = '';
            
            if (expenses.length === 0) { 
                list.innerHTML = '<div class="empty-state"><i class="fas fa-receipt"></i><p>尚未記錄任何花費</p></div>'; 
                return; 
            }
            
            // 按日期排序，最新的在前
            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedExpenses.forEach(expense => {
                const item = document.createElement('div'); 
                item.className = 'account-item';
                
                const categoryNames = { 
                    'food':'餐飲', 
                    'transportation':'交通', 
                    'accommodation':'住宿',
                    'shopping':'購物', 
                    'leisure':'休閒娛樂',
                    'other':'其他' 
                };
                
                const categoryColors = {
                    'food': '#e1f5fe',
                    'transportation': '#f3e5f5',
                    'accommodation': '#e8f5e8',
                    'shopping': '#fff3e0',
                    'leisure': '#fce4ec',
                    'other': '#f5f5f5'
                };
                
                const categoryTextColors = {
                    'food': '#0277bd',
                    'transportation': '#7b1fa2',
                    'accommodation': '#2e7d32',
                    'shopping': '#ef6c00',
                    'leisure': '#c2185b',
                    'other': '#616161'
                };
                
                const categoryIcons = {
                    'food': 'fas fa-utensils',
                    'transportation': 'fas fa-bus',
                    'accommodation': 'fas fa-hotel',
                    'shopping': 'fas fa-shopping-bag',
                    'leisure': 'fas fa-film',
                    'other': 'fas fa-question-circle'
                };
                
                item.innerHTML = `
                    <div>
                        <div style="font-weight:bold;">${expense.name}</div>
                        <div style="font-size:14px;color:var(--text-light);"><i class="fas fa-calendar"></i> ${expense.formattedDate || expense.date}</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="padding:5px 12px; border-radius:20px; font-size:12px; font-weight:bold; 
                             background:${categoryColors[expense.category] || '#f5f5f5'}; 
                             color:${categoryTextColors[expense.category] || '#616161'}; display:flex; align-items:center; gap:5px;">
                            <i class="${categoryIcons[expense.category] || 'fas fa-question-circle'}"></i>
                            ${categoryNames[expense.category] || expense.category}
                        </div>
                        <div style="font-weight:bold;color:#EA5455;font-size:18px;">${expense.amount.toLocaleString()} 元</div>
                        <button class="delete-btn" onclick="deleteExpense(${expense.id})" title="刪除"><i class="fas fa-trash"></i></button>
                    </div>`;
                list.appendChild(item);
            });
        }

        // ==================== 筆記功能 ====================
        function addDiaryEntry() {
            const title = document.getElementById('diary-title').value;
            const content = document.getElementById('diary-content').value;
            const imageInput = document.getElementById('diary-image');
            
            if (!title || !content) { 
                alert('請填寫標題和內容'); 
                return; 
            }
            
            const entry = { 
                id: Date.now(), 
                title, 
                content, 
                date: new Date().toLocaleString('zh-TW'), 
                image: null 
            };
            
            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { 
                    entry.image = e.target.result; 
                    diaryEntries.unshift(entry); 
                    renderDiaryEntries(); 
                    saveDiaryToLocalStorage(); 
                    resetDiaryForm(); 
                    showNotification('筆記已新增！', 'success'); 
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else { 
                diaryEntries.unshift(entry); 
                renderDiaryEntries(); 
                saveDiaryToLocalStorage(); 
                resetDiaryForm(); 
                showNotification('筆記已新增！', 'success'); 
            }
        }
        
        function deleteDiaryEntry(id) {
            const index = diaryEntries.findIndex(entry => entry.id === id);
            if (index !== -1) { 
                diaryEntries.splice(index, 1); 
                renderDiaryEntries(); 
                saveDiaryToLocalStorage(); 
                showNotification('筆記已刪除', 'info');
            }
        }
        
        function renderDiaryEntries() {
            const list = document.getElementById('diary-list'); 
            list.innerHTML = '';
            
            if (diaryEntries.length === 0) { 
                list.innerHTML = '<div class="empty-state"><i class="fas fa-book"></i><p>尚未撰寫任何筆記</p></div>'; 
                return; 
            }
            
            diaryEntries.forEach(entry => {
                const entryEl = document.createElement('div'); 
                entryEl.className = 'account-item';
                entryEl.style.flexDirection = 'column';
                entryEl.style.alignItems = 'flex-start';
                
                let imageHTML = ''; 
                if (entry.image) { 
                    imageHTML = `<img src="${entry.image}" alt="筆記圖片" style="max-width:100%; border-radius:var(--radius-sm); margin-top:15px;">`; 
                }
                
                entryEl.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; width:100%;">
                        <div style="flex-grow:1;">
                            <div style="font-weight:bold;font-size:18px;margin-bottom:8px;color:var(--dark);"><i class="fas fa-sticky-note"></i> ${entry.title}</div>
                            <div style="font-size:14px; color:#7f8c8d;"><i class="fas fa-calendar"></i> ${entry.date}</div>
                        </div>
                        <button class="delete-btn" onclick="deleteDiaryEntry(${entry.id})" title="刪除"><i class="fas fa-trash"></i></button>
                    </div>
                    <div style="margin-top:12px; line-height:1.6; width:100%; font-size:14px;">${entry.content.replace(/\n/g, '<br>')}</div>
                    ${imageHTML}`;
                list.appendChild(entryEl);
            });
        }
        
        function resetDiaryForm() {
            document.getElementById('diary-title').value = '';
            document.getElementById('diary-content').value = '';
            document.getElementById('diary-image').value = '';
        }

        // ==================== 旅程簡介功能 ====================
        function renderTripInfo() {
            renderFlights();
            renderHotels();
            renderCars();
            renderOthers();
        }
        
        function renderFlights() {
            const container = document.getElementById('flight-container');
            
            if (tripInfo.flights.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-plane"></i>
                        <p>尚未添加航班資訊</p>
                        <button class="edit-btn" onclick="editFlight()"><i class="fas fa-plus"></i> 添加航班資訊</button>
                    </div>`;
                return;
            }
            
            let flightsHtml = '';
            tripInfo.flights.forEach((flight, index) => {
                flightsHtml += `
                    <div class="boarding-pass" style="margin-bottom: 15px;">
                        <div class="pass-header">
                            <div class="pass-airline">${flight.airline || '航空公司'}</div>
                            <div class="pass-flight">${flight.flightNumber || '航班號碼'}</div>
                        </div>
                        <div class="pass-details">
                            <div class="pass-from">
                                <div class="pass-city">${flight.departureCity || '出發城市'}</div>
                                <div class="pass-airport">${flight.departureAirport || '機場'}</div>
                                <div style="margin-top: 10px; font-size: 16px; font-weight: 700;">${formatFlightTime(flight.departureTime)}</div>
                            </div>
                            <div class="pass-plane"><i class="fas fa-plane"></i></div>
                            <div class="pass-to">
                                <div class="pass-city">${flight.arrivalCity || '到達城市'}</div>
                                <div class="pass-airport">${flight.arrivalAirport || '機場'}</div>
                                <div style="margin-top: 10px; font-size: 16px; font-weight: 700;">${formatFlightTime(flight.arrivalTime)}</div>
                            </div>
                        </div>
                        <div class="pass-info">
                            <div class="pass-info-item">
                                <div class="info-label">日期</div>
                                <div class="info-value">${flight.date || '未設定'}</div>
                            </div>
                            <div class="pass-info-item">
                                <div class="info-label">艙等</div>
                                <div class="info-value">${flight.class || '經濟艙'}</div>
                            </div>
                            <div class="pass-info-item">
                                <div class="info-label">座位</div>
                                <div class="info-value">${flight.seat || '未指定'}</div>
                            </div>
                        </div>
                        ${flight.remarks ? `<div style="margin-top: 12px; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 13px;"><i class="fas fa-sticky-note"></i> ${flight.remarks}</div>` : ''}
                        <div style="display: flex; gap: 10px; margin-top: 12px;">
                            <button class="edit-btn" onclick="editFlight(${flight.id})" style="background: var(--secondary);"><i class="fas fa-edit"></i> 編輯</button>
                            <button class="edit-btn" onclick="deleteFlight(${flight.id})" style="background: #EA5455;"><i class="fas fa-trash"></i> 刪除</button>
                        </div>
                    </div>`;
            });
            
            container.innerHTML = flightsHtml + `<button class="edit-btn" onclick="editFlight()" style="margin-top: 12px;"><i class="fas fa-plus"></i> 添加另一航班</button>`;
        }
        
        function renderHotels() {
            const container = document.getElementById('hotel-container');
            
            if (tripInfo.hotels.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bed"></i>
                        <p>尚未添加酒店資訊</p>
                        <button class="edit-btn" onclick="editHotel()"><i class="fas fa-plus"></i> 添加酒店資訊</button>
                    </div>`;
                return;
            }
            
            let hotelsHtml = '';
            tripInfo.hotels.forEach((hotel, index) => {
                hotelsHtml += `
                    <div class="hotel-card">
                        <div class="hotel-name"><i class="fas fa-hotel"></i> ${hotel.name || '未命名酒店'}</div>
                        <div class="hotel-address"><i class="fas fa-map-marker-alt"></i> ${hotel.address || '未設定地址'}</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 12px;">
                            <div style="padding: 8px; background-color: rgba(144, 171, 139, 0.05); border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-light);"><i class="fas fa-sign-in-alt"></i> 入住</div>
                                <div style="font-weight: 600;">${hotel.checkin || '未設定'}</div>
                            </div>
                            <div style="padding: 8px; background-color: rgba(144, 171, 139, 0.05); border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-light);"><i class="fas fa-sign-out-alt"></i> 退房</div>
                                <div style="font-weight: 600;">${hotel.checkout || '未設定'}</div>
                            </div>
                        </div>
                        ${hotel.remarks ? `<div class="hotel-remarks"><i class="fas fa-sticky-note"></i> ${hotel.remarks}</div>` : ''}
                        <div style="display: flex; gap: 10px; margin-top: 12px;">
                            <button class="edit-btn" onclick="editHotel(${hotel.id})"><i class="fas fa-edit"></i> 編輯</button>
                            <button class="edit-btn" onclick="deleteHotel(${hotel.id})" style="background: #EA5455;"><i class="fas fa-trash"></i> 刪除</button>
                        </div>
                    </div>`;
            });
            
            container.innerHTML = hotelsHtml + `<button class="edit-btn" onclick="editHotel()" style="margin-top: 12px;"><i class="fas fa-plus"></i> 添加另一酒店</button>`;
        }
        
        function renderCars() {
            const container = document.getElementById('car-container');
            
            if (tripInfo.cars.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-car-side"></i>
                        <p>尚未添加租車資訊</p>
                        <button class="edit-btn" onclick="editCar()"><i class="fas fa-plus"></i> 添加租車資訊</button>
                    </div>`;
                return;
            }
            
            let carsHtml = '';
            tripInfo.cars.forEach((car, index) => {
                carsHtml += `
                    <div class="car-card">
                        <div class="car-company"><i class="fas fa-car"></i> ${car.company || '租車公司'}</div>
                        <div class="car-details">
                            <div class="car-detail-item">
                                <div style="font-size: 12px; color: var(--text-light);"><i class="fas fa-map-marker-alt"></i> 取車地點</div>
                                <div style="font-weight: 600;">${car.pickupLocation || '未設定'}</div>
                            </div>
                            <div class="car-detail-item">
                                <div style="font-size: 12px; color: var(--text-light);"><i class="fas fa-map-marker-alt"></i> 還車地點</div>
                                <div style="font-weight: 600;">${car.returnLocation || '未設定'}</div>
                            </div>
                            <div class="car-detail-item">
                                <div style="font-size: 12px; color: var(--text-light);"><i class="fas fa-calendar-check"></i> 取車時間</div>
                                <div style="font-weight: 600;">${formatDateTime(car.pickupTime) || '未設定'}</div>
                            </div>
                            <div class="car-detail-item">
                                <div style="font-size: 12px; color: var(--text-light);"><i class="fas fa-calendar-times"></i> 還車時間</div>
                                <div style="font-weight: 600;">${formatDateTime(car.returnTime) || '未設定'}</div>
                            </div>
                        </div>
                        ${car.remarks ? `<div class="car-remarks"><i class="fas fa-sticky-note"></i> ${car.remarks}</div>` : ''}
                        <div style="display: flex; gap: 10px; margin-top: 12px;">
                            <button class="edit-btn" onclick="editCar(${car.id})"><i class="fas fa-edit"></i> 編輯</button>
                            <button class="edit-btn" onclick="deleteCar(${car.id})" style="background: #EA5455;"><i class="fas fa-trash"></i> 刪除</button>
                        </div>
                    </div>`;
            });
            
            container.innerHTML = carsHtml + `<button class="edit-btn" onclick="editCar()" style="margin-top: 12px;"><i class="fas fa-plus"></i> 添加另一租車</button>`;
        }
        
        function renderOthers() {
            const container = document.getElementById('other-container');
            
            if (tripInfo.others.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-sticky-note"></i>
                        <p>尚未添加其他資訊</p>
                        <button class="edit-btn" onclick="editOther()"><i class="fas fa-plus"></i> 添加其他資訊</button>
                    </div>`;
                return;
            }
            
            let othersHtml = '';
            tripInfo.others.forEach((other, index) => {
                othersHtml += `
                    <div class="other-info-item">
                        <div class="other-title"><i class="fas fa-info-circle"></i> ${other.title || '未命名'}</div>
                        <div class="other-content">${other.content.replace(/\n/g, '<br>') || '無內容'}</div>
                        <div style="display: flex; gap: 10px; margin-top: 12px;">
                            <button class="edit-btn" onclick="editOther(${other.id})"><i class="fas fa-edit"></i> 編輯</button>
                            <button class="edit-btn" onclick="deleteOther(${other.id})" style="background: #EA5455;"><i class="fas fa-trash"></i> 刪除</button>
                        </div>
                    </div>`;
            });
            
            container.innerHTML = othersHtml + `<button class="edit-btn" onclick="editOther()" style="margin-top: 12px;"><i class="fas fa-plus"></i> 添加其他資訊</button>`;
        }
        
        function formatFlightTime(timeStr) {
            if (!timeStr) return '--:--';
            const date = new Date(timeStr);
            return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
        }
        
        // 航班編輯功能
        let editingFlightId = null;
        
        function editFlight(id = null) {
            editingFlightId = id;
            const flightForm = document.getElementById('flight-form');
            
            // 如果是編輯現有航班，獲取航班數據
            let flightData = { isRoundTrip: true };
            if (id) {
                const flight = tripInfo.flights.find(f => f.id === id);
                if (flight) flightData = flight;
            }
            
            flightForm.innerHTML = `
                <div class="input-group">
                    <label style="display:block; margin-bottom:5px; font-weight:600;">航班類型</label>
                    <select id="flight-type" style="margin-bottom:12px;" onchange="toggleRoundTrip()">
                        <option value="roundtrip" ${flightData.isRoundTrip ? 'selected' : ''}>來回航班</option>
                        <option value="oneway" ${!flightData.isRoundTrip ? 'selected' : ''}>單程航班</option>
                    </select>
                    
                    <div id="outbound-flight">
                        <h4 style="margin:15px 0 8px 0; color:var(--dark);">去程航班</h4>
                        <input type="text" id="outbound-airline" placeholder="航空公司" value="${flightData.outboundAirline || ''}">
                        <input type="text" id="outbound-flight-number" placeholder="航班號碼" value="${flightData.outboundFlightNumber || ''}">
                        <input type="text" id="outbound-departure-city" placeholder="出發城市" value="${flightData.outboundDepartureCity || ''}">
                        <input type="text" id="outbound-departure-airport" placeholder="出發機場" value="${flightData.outboundDepartureAirport || ''}">
                        <label class="date-label">出發時間</label>
                        <input type="datetime-local" id="outbound-departure-time" value="${flightData.outboundDepartureTime || ''}">
                        <input type="text" id="outbound-arrival-city" placeholder="到達城市" value="${flightData.outboundArrivalCity || ''}">
                        <input type="text" id="outbound-arrival-airport" placeholder="到達機場" value="${flightData.outboundArrivalAirport || ''}">
                        <label class="date-label">到達時間</label>
                        <input type="datetime-local" id="outbound-arrival-time" value="${flightData.outboundArrivalTime || ''}">
                        <label class="date-label">日期</label>
                        <input type="date" id="outbound-date" placeholder="請選擇日期" value="${flightData.outboundDate || ''}">
                        <input type="text" id="outbound-class" placeholder="艙等 (如: 經濟艙)" value="${flightData.outboundClass || ''}">
                        <input type="text" id="outbound-seat" placeholder="座位號碼" value="${flightData.outboundSeat || ''}">
                        <textarea id="outbound-remarks" placeholder="備註" rows="2">${flightData.outboundRemarks || ''}</textarea>
                    </div>
                    
                    <div id="inbound-flight" style="${flightData.isRoundTrip ? '' : 'display:none;'}">
                        <h4 style="margin:15px 0 8px 0; color:var(--dark);">回程航班</h4>
                        <input type="text" id="inbound-airline" placeholder="航空公司" value="${flightData.inboundAirline || ''}">
                        <input type="text" id="inbound-flight-number" placeholder="航班號碼" value="${flightData.inboundFlightNumber || ''}">
                        <input type="text" id="inbound-departure-city" placeholder="出發城市" value="${flightData.inboundDepartureCity || ''}">
                        <input type="text" id="inbound-departure-airport" placeholder="出發機場" value="${flightData.inboundDepartureAirport || ''}">
                        <label class="date-label">出發時間</label>
                        <input type="datetime-local" id="inbound-departure-time" value="${flightData.inboundDepartureTime || ''}">
                        <input type="text" id="inbound-arrival-city" placeholder="到達城市" value="${flightData.inboundArrivalCity || ''}">
                        <input type="text" id="inbound-arrival-airport" placeholder="到達機場" value="${flightData.inboundArrivalAirport || ''}">
                        <label class="date-label">到達時間</label>
                        <input type="datetime-local" id="inbound-arrival-time" value="${flightData.inboundArrivalTime || ''}">
                        <label class="date-label">日期</label>
                        <input type="date" id="inbound-date" placeholder="請選擇日期" value="${flightData.inboundDate || ''}">
                        <input type="text" id="inbound-class" placeholder="艙等 (如: 經濟艙)" value="${flightData.inboundClass || ''}">
                        <input type="text" id="inbound-seat" placeholder="座位號碼" value="${flightData.inboundSeat || ''}">
                        <textarea id="inbound-remarks" placeholder="備註" rows="2">${flightData.inboundRemarks || ''}</textarea>
                    </div>
                    
                    <textarea id="flight-general-remarks" placeholder="航班通用備註" rows="2">${flightData.remarks || ''}</textarea>
                </div>`;
            
            document.getElementById('flight-modal').style.display = 'flex';
        }
        
        function toggleRoundTrip() {
            const flightType = document.getElementById('flight-type').value;
            const inboundFlight = document.getElementById('inbound-flight');
            
            if (flightType === 'roundtrip') {
                inboundFlight.style.display = 'block';
            } else {
                inboundFlight.style.display = 'none';
            }
        }
        
        function saveFlight() {
            const flightType = document.getElementById('flight-type').value;
            const isRoundTrip = flightType === 'roundtrip';
            
            // 如果是來回航班，保存兩個航班
            if (isRoundTrip) {
                // 去程航班
                const outboundFlight = {
                    id: editingFlightId || Date.now(),
                    airline: document.getElementById('outbound-airline').value,
                    flightNumber: document.getElementById('outbound-flight-number').value,
                    departureCity: document.getElementById('outbound-departure-city').value,
                    departureAirport: document.getElementById('outbound-departure-airport').value,
                    departureTime: document.getElementById('outbound-departure-time').value,
                    arrivalCity: document.getElementById('outbound-arrival-city').value,
                    arrivalAirport: document.getElementById('outbound-arrival-airport').value,
                    arrivalTime: document.getElementById('outbound-arrival-time').value,
                    date: document.getElementById('outbound-date').value,
                    class: document.getElementById('outbound-class').value,
                    seat: document.getElementById('outbound-seat').value,
                    remarks: document.getElementById('outbound-remarks').value,
                    isOutbound: true,
                    isRoundTrip: true
                };
                
                // 回程航班
                const inboundFlight = {
                    id: (editingFlightId || Date.now()) + 1,
                    airline: document.getElementById('inbound-airline').value,
                    flightNumber: document.getElementById('inbound-flight-number').value,
                    departureCity: document.getElementById('inbound-departure-city').value,
                    departureAirport: document.getElementById('inbound-departure-airport').value,
                    departureTime: document.getElementById('inbound-departure-time').value,
                    arrivalCity: document.getElementById('inbound-arrival-city').value,
                    arrivalAirport: document.getElementById('inbound-arrival-airport').value,
                    arrivalTime: document.getElementById('inbound-arrival-time').value,
                    date: document.getElementById('inbound-date').value,
                    class: document.getElementById('inbound-class').value,
                    seat: document.getElementById('inbound-seat').value,
                    remarks: document.getElementById('inbound-remarks').value,
                    isOutbound: false,
                    isRoundTrip: true
                };
                
                // 刪除現有的航班（如果是編輯）
                if (editingFlightId) {
                    tripInfo.flights = tripInfo.flights.filter(f => f.id !== editingFlightId && f.id !== editingFlightId + 1);
                }
                
                // 添加新航班
                tripInfo.flights.push(outboundFlight);
                tripInfo.flights.push(inboundFlight);
            } else {
                // 單程航班
                const flight = {
                    id: editingFlightId || Date.now(),
                    airline: document.getElementById('outbound-airline').value,
                    flightNumber: document.getElementById('outbound-flight-number').value,
                    departureCity: document.getElementById('outbound-departure-city').value,
                    departureAirport: document.getElementById('outbound-departure-airport').value,
                    departureTime: document.getElementById('outbound-departure-time').value,
                    arrivalCity: document.getElementById('outbound-arrival-city').value,
                    arrivalAirport: document.getElementById('outbound-arrival-airport').value,
                    arrivalTime: document.getElementById('outbound-arrival-time').value,
                    date: document.getElementById('outbound-date').value,
                    class: document.getElementById('outbound-class').value,
                    seat: document.getElementById('outbound-seat').value,
                    remarks: document.getElementById('outbound-remarks').value + (document.getElementById('flight-general-remarks').value ? '\n' + document.getElementById('flight-general-remarks').value : ''),
                    isOutbound: true,
                    isRoundTrip: false
                };
                
                // 刪除現有的航班（如果是編輯）
                if (editingFlightId) {
                    tripInfo.flights = tripInfo.flights.filter(f => f.id !== editingFlightId);
                }
                
                // 添加新航班
                tripInfo.flights.push(flight);
            }
            
            saveTripInfo();
            renderFlights();
            closeModal('flight-modal');
            showNotification('航班資訊已儲存！', 'success');
        }
        
        function deleteFlight(id) {
            if (confirm('確定要刪除這個航班嗎？')) {
                // 如果是來回航班，刪除兩個航班
                const flight = tripInfo.flights.find(f => f.id === id);
                if (flight && flight.isRoundTrip) {
                    tripInfo.flights = tripInfo.flights.filter(f => f.id !== id && f.id !== id + 1);
                } else {
                    tripInfo.flights = tripInfo.flights.filter(f => f.id !== id);
                }
                
                saveTripInfo();
                renderFlights();
                showNotification('航班已刪除', 'info');
            }
        }
        
        // 酒店編輯功能
        let editingHotelId = null;
        
        function editHotel(id = null) {
            editingHotelId = id;
            
            if (id) {
                const hotel = tripInfo.hotels.find(h => h.id === id);
                if (hotel) {
                    document.getElementById('hotel-name').value = hotel.name || '';
                    document.getElementById('hotel-address').value = hotel.address || '';
                    document.getElementById('hotel-checkin').value = hotel.checkin || '';
                    document.getElementById('hotel-checkout').value = hotel.checkout || '';
                    document.getElementById('hotel-remarks-input').value = hotel.remarks || '';
                }
            } else {
                document.getElementById('hotel-name').value = '';
                document.getElementById('hotel-address').value = '';
                document.getElementById('hotel-checkin').value = '';
                document.getElementById('hotel-checkout').value = '';
                document.getElementById('hotel-remarks-input').value = '';
            }
            
            document.getElementById('hotel-modal').style.display = 'flex';
        }
        
        function saveHotel() {
            const hotel = {
                id: editingHotelId || Date.now(),
                name: document.getElementById('hotel-name').value,
                address: document.getElementById('hotel-address').value,
                checkin: document.getElementById('hotel-checkin').value,
                checkout: document.getElementById('hotel-checkout').value,
                remarks: document.getElementById('hotel-remarks-input').value
            };
            
            if (editingHotelId) {
                const index = tripInfo.hotels.findIndex(h => h.id === editingHotelId);
                if (index !== -1) {
                    tripInfo.hotels[index] = hotel;
                }
            } else {
                tripInfo.hotels.push(hotel);
            }
            
            saveTripInfo();
            renderHotels();
            closeModal('hotel-modal');
            
            // 更新地圖
            if (map) {
                updateMap();
            }
            
            showNotification('酒店資訊已儲存！', 'success');
        }
        
        function deleteHotel(id) {
            if (confirm('確定要刪除這個酒店嗎？')) {
                tripInfo.hotels = tripInfo.hotels.filter(h => h.id !== id);
                saveTripInfo();
                renderHotels();
                
                // 更新地圖
                if (map) {
                    updateMap();
                }
                
                showNotification('酒店已刪除', 'info');
            }
        }
        
        // 租車編輯功能
        let editingCarId = null;
        
        function editCar(id = null) {
            editingCarId = id;
            
            if (id) {
                const car = tripInfo.cars.find(c => c.id === id);
                if (car) {
                    document.getElementById('car-company').value = car.company || '';
                    document.getElementById('car-pickup-location').value = car.pickupLocation || '';
                    document.getElementById('car-return-location').value = car.returnLocation || '';
                    document.getElementById('car-pickup-time').value = car.pickupTime || '';
                    document.getElementById('car-return-time').value = car.returnTime || '';
                    document.getElementById('car-remarks-input').value = car.remarks || '';
                }
            } else {
                document.getElementById('car-company').value = '';
                document.getElementById('car-pickup-location').value = '';
                document.getElementById('car-return-location').value = '';
                document.getElementById('car-pickup-time').value = '';
                document.getElementById('car-return-time').value = '';
                document.getElementById('car-remarks-input').value = '';
            }
            
            document.getElementById('car-modal').style.display = 'flex';
        }
        
        function saveCar() {
            const car = {
                id: editingCarId || Date.now(),
                company: document.getElementById('car-company').value,
                pickupLocation: document.getElementById('car-pickup-location').value,
                returnLocation: document.getElementById('car-return-location').value,
                pickupTime: document.getElementById('car-pickup-time').value,
                returnTime: document.getElementById('car-return-time').value,
                remarks: document.getElementById('car-remarks-input').value
            };
            
            if (editingCarId) {
                const index = tripInfo.cars.findIndex(c => c.id === editingCarId);
                if (index !== -1) {
                    tripInfo.cars[index] = car;
                }
            } else {
                tripInfo.cars.push(car);
            }
            
            saveTripInfo();
            renderCars();
            closeModal('car-modal');
            
            // 更新地圖
            if (map) {
                updateMap();
            }
            
            showNotification('租車資訊已儲存！', 'success');
        }
        
        function deleteCar(id) {
            if (confirm('確定要刪除這個租車資訊嗎？')) {
                tripInfo.cars = tripInfo.cars.filter(c => c.id !== id);
                saveTripInfo();
                renderCars();
                
                // 更新地圖
                if (map) {
                    updateMap();
                }
                
                showNotification('租車資訊已刪除', 'info');
            }
        }
        
        // 其他資訊編輯功能
        let editingOtherId = null;
        
        function editOther(id = null) {
            editingOtherId = id;
            
            if (id) {
                const other = tripInfo.others.find(o => o.id === id);
                if (other) {
                    document.getElementById('other-title-input').value = other.title || '';
                    document.getElementById('other-content-input').value = other.content || '';
                }
            } else {
                document.getElementById('other-title-input').value = '';
                document.getElementById('other-content-input').value = '';
            }
            
            document.getElementById('other-modal').style.display = 'flex';
        }
        
        function saveOther() {
            const other = {
                id: editingOtherId || Date.now(),
                title: document.getElementById('other-title-input').value,
                content: document.getElementById('other-content-input').value
            };
            
            if (editingOtherId) {
                const index = tripInfo.others.findIndex(o => o.id === editingOtherId);
                if (index !== -1) {
                    tripInfo.others[index] = other;
                }
            } else {
                tripInfo.others.push(other);
            }
            
            saveTripInfo();
            renderOthers();
            closeModal('other-modal');
            showNotification('其他資訊已儲存！', 'success');
        }
        
        function deleteOther(id) {
            if (confirm('確定要刪除這個資訊嗎？')) {
                tripInfo.others = tripInfo.others.filter(o => o.id !== id);
                saveTripInfo();
                renderOthers();
                showNotification('其他資訊已刪除', 'info');
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // 通知功能
        function showNotification(message, type = 'info') {
            // 創建通知元素
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: ${type === 'success' ? '#90AB8B' : type === 'info' ? '#5A7863' : '#EA5455'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 10001;
                animation: slideIn 0.3s ease;
                display: flex;
                align-items: center;
                gap: 10px;
                max-width: 300px;
            `;
            
            const icon = type === 'success' ? 'fas fa-check-circle' : 
                        type === 'info' ? 'fas fa-info-circle' : 'fas fa-exclamation-circle';
            
            notification.innerHTML = `<i class="${icon}"></i><span>${message}</span>`;
            document.body.appendChild(notification);
            
            // 3秒後移除通知
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // 添加CSS動畫
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // ==================== 本地儲存功能 ====================
        function saveToLocalStorage() { 
            localStorage.setItem('travelActivities', JSON.stringify(activities)); 
            localStorage.setItem('dateColors', JSON.stringify(dateColors)); 
        }
        
        function saveExpensesToLocalStorage() { 
            localStorage.setItem('travelExpenses', JSON.stringify(expenses)); 
        }
        
        function saveDiaryToLocalStorage() { 
            localStorage.setItem('travelDiary', JSON.stringify(diaryEntries)); 
        }
        
        // 儲存旅程簡介數據
        function saveTripInfo() {
            localStorage.setItem('tripInfo', JSON.stringify(tripInfo));
        }
        
        function loadFromLocalStorage() {
            const savedActivities = localStorage.getItem('travelActivities');
            if (savedActivities) { 
                activities.length = 0; 
                activities.push(...JSON.parse(savedActivities)); 
                renderItinerary(); 
                updateMapLocations();
                
                // 載入後計算交通時間
                calculateTravelTimes();
            }
            
            const savedExpenses = localStorage.getItem('travelExpenses');
            if (savedExpenses) { 
                expenses.length = 0; 
                expenses.push(...JSON.parse(savedExpenses)); 
                updateExpenseTotal();
                renderExpenses(); 
            }
            
            const savedDiary = localStorage.getItem('travelDiary');
            if (savedDiary) { 
                diaryEntries.length = 0; 
                diaryEntries.push(...JSON.parse(savedDiary)); 
                renderDiaryEntries(); 
            }
            
            // 載入旅程簡介數據
            const savedTripInfo = localStorage.getItem('tripInfo');
            if (savedTripInfo) {
                tripInfo = JSON.parse(savedTripInfo);
                renderTripInfo();
            }
            
            ['itinerary', 'map', 'account', 'diary', 'trip'].forEach(page => loadBackground(page));
        }

        // ==================== 頁面初始化 ====================
        window.onload = function() {
            loadFromLocalStorage();
            renderItinerary(); 
            updateExpenseTotal();
            renderExpenses(); 
            renderDiaryEntries();
            updateMapLocations();
            renderTripInfo();
            
            // 設置今天為預設日期
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expense-date').value = today;
            
            // 設置日期輸入框的placeholder
            document.getElementById('time-input').setAttribute('placeholder', '請選擇日期和時間');
            
            console.log('旅行規劃頁面已載入完成！');
            console.log('請替換第16行的Google Maps API金鑰以啟用地圖和交通時間功能。');
        };
    </script>
</body>
</html>
