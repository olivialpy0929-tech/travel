<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—…è¡Œè¦åŠƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <!-- â˜… Google Maps API - å¿…é ˆæ›¿æ›ç‚ºæ‚¨çš„APIé‡‘é‘° â˜… -->
    <!-- å‰å¾€ https://console.cloud.google.com å•Ÿç”¨ Maps JavaScript API å’Œ Directions API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPr1fdJUrgy-b4lMzy_Zb8W-ihMY_Or9U&libraries=places,directions&callback=initMap" async defer></script>
    
    <style>
        :root {
            --primary: #8A9EA8; --secondary: #C9B8A3; --accent: #A3C9B8;
            --light: #F8F5F2; --dark: #5A6D73; --text: #333333;
            --shadow: rgba(138, 158, 168, 0.15); --radius: 20px; --radius-sm: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, 'Microsoft JhengHei', sans-serif; }
        body { background-color: var(--light); color: var(--text); min-height: 100vh; padding-bottom: 90px; line-height: 1.6; }

        /* å¯è‡ªè¨‚çš„é é¢èƒŒæ™¯ (æ‡‰ç”¨æ–¼æ•´å€‹ .page) */
        .page-with-bg {
            position: relative;
            border-radius: var(--radius);
            overflow: hidden; /* ç¢ºä¿èƒŒæ™¯åœ–ä¸æº¢å‡ºåœ“è§’ */
            box-shadow: 0 10px 30px var(--shadow);
            border: 1px solid rgba(138, 158, 168, 0.08);
        }
        .page-bg-layer {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.6; /* èƒŒæ™¯åœ–é€æ˜åº¦ 60% */
            z-index: 1;
        }
        .page-content {
            position: relative; /* ç¢ºä¿å…§å®¹åœ¨èƒŒæ™¯åœ–ä¸Šæ–¹ */
            z-index: 2;
            padding: 30px;
            background: rgba(255, 255, 255, 0.85); /* å…§å®¹å€è¼•å¾®ç™½è‰²èƒŒæ™¯ï¼Œæé«˜æ–‡å­—å¯è®€æ€§ */
            border-radius: var(radius);
        }

        /* èƒŒæ™¯è¨­å®šæŒ‰éˆ• */
        .bg-setting-btn {
            position: absolute; top: 15px; right: 15px;
            background: rgba(255, 255, 255, 0.9); 
            border: none; width: 36px; height: 36px;
            border-radius: 50%; font-size: 18px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: all 0.3s; z-index: 3; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
        }
        .bg-setting-btn:hover { background: white; transform: scale(1.1); }
        /* èƒŒæ™¯è¨­å®šé¢æ¿ */
        .bg-setting-panel {
            display: none; position: absolute; top: 60px; right: 15px;
            background: white; padding: 20px; border-radius: var(--radius-sm);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 4; min-width: 250px;
            border: 1px solid rgba(138, 158, 168, 0.1);
        }
        .bg-setting-panel h4 { margin-bottom: 10px; color: var(--dark); }
        .bg-setting-panel input[type="file"] { width: 100%; margin-bottom: 15px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; }
        .bg-setting-panel button { background: var(--accent); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; width: 100%; }

        /* ä¸»å…§å®¹å€ */
        .main-content { padding: 25px; }
        .page { display: none; margin-top: 25px; } /* åŸºç¤æ¨£å¼ï¼Œå¯¦éš›æ¨£å¼ç”± .page-with-bg æä¾› */
        .page.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* æ¨™é¡Œæ¡† - ç½®ä¸­ï¼Œèˆ‡ä¸‹æ–¹ä¿æŒ2cmè·é›¢ */
        .header-title-container {
            text-align: center;
            margin: 0 auto 2cm; /* ä¸‹é‚Šè· 2cm */
            display: flex;
            justify-content: center;
        }
        .title-container {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            padding: 15px 30px;
            border-radius: 50px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            box-shadow: 0 6px 20px var(--shadow);
            max-width: 80%;
        }
        #app-title {
            font-size: 26px;
            font-weight: 700;
            border: none;
            background: transparent;
            color: white;
            text-align: center;
            outline: none;
            min-width: 200px;
            cursor: pointer;
        }

        h2 { color: var(--dark); margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--light); font-size: 24px; display: flex; align-items: center; gap: 10px; }

        /* è¡¨å–® */
        .input-group { margin-bottom: 30px; }
        input, textarea, select {
            width: 100%; padding: 16px 20px; margin: 10px 0; border: 2px solid #eee;
            border-radius: var(--radius-sm); font-size: 16px; transition: all 0.3s; background: #fcfcfc;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent); background: white; box-shadow: 0 0 0 3px rgba(163, 201, 184, 0.2); }
        
        /* ç‰¹åˆ¥ç‚ºæ—¥æœŸè¼¸å…¥æ¡†èª¿æ•´ï¼Œä½¿å…¶èˆ‡å…¶ä»–è¼¸å…¥æ¡†é‚Šæ¡†å¤§å°ä¸€è‡´ */
        input[type="datetime-local"] {
            padding: 16px 20px !important;
            border: 2px solid #eee !important;
        }
        
        button.primary-btn {
            background: linear-gradient(to right, var(--primary), var(--accent)); color: white; border: none;
            padding: 17px 30px; border-radius: var(--radius-sm); font-size: 17px; font-weight: 600;
            cursor: pointer; transition: all 0.3s; margin-top: 15px; width: 100%; letter-spacing: 0.5px;
        }
        button.primary-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(138, 158, 168, 0.3); }

        /* åº•éƒ¨å°èˆª */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            display: flex; justify-content: space-around; padding: 18px 0;
            box-shadow: 0 -5px 25px var(--shadow); z-index: 1000; border-top: 1px solid rgba(138, 158, 168, 0.1);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 12px 25px; border-radius: var(--radius-sm); transition: all 0.3s; color: var(--text-light); }
        .nav-item.active { background: rgba(138, 158, 168, 0.1); color: var(--primary); }
        .nav-icon { font-size: 26px; margin-bottom: 6px; }
        .nav-text { font-size: 14px; font-weight: 500; }

        /* è¡Œç¨‹åˆ—è¡¨æ¨£å¼ */
        #itinerary-list { margin-top: 20px; }
        .date-section { margin-bottom: 35px; background: rgba(248, 245, 242, 0.7); border-radius: var(--radius); padding: 25px; border-left: 6px solid var(--accent); }
        .date-header { font-size: 20px; font-weight: 700; color: var(--dark); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px dashed rgba(138, 158, 168, 0.3); }
        .sortable-list { min-height: 20px; }
        .itinerary-item {
            background: white; border-radius: var(--radius-sm); padding: 22px; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid rgba(138, 158, 168, 0.1);
            transition: all 0.3s; cursor: move;
        }
        .itinerary-item:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(138, 158, 168, 0.15); }
        .item-content { flex-grow: 1; }
        .item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .item-title { font-weight: 700; color: var(--text); font-size: 18px; }
        .item-time { color: var(--primary); font-size: 15px; font-weight: 600; background: rgba(138, 158, 168, 0.1); padding: 5px 12px; border-radius: 20px; }
        .item-location { color: var(--text-light); margin: 8px 0; font-size: 15px; }
        .item-remarks { color: var(--text); margin-top: 10px; padding: 12px; background: rgba(201, 184, 163, 0.08); border-radius: 10px; font-size: 15px; border-left: 3px solid var(--secondary); }
        
        /* æ–°å¢ï¼šäº¤é€šæ™‚é–“é¡¯ç¤º */
        .travel-time {
            display: inline-block;
            margin-top: 8px;
            padding: 4px 10px;
            background-color: rgba(163, 201, 184, 0.2);
            border-radius: 15px;
            font-size: 13px;
            color: var(--dark);
            font-weight: 500;
        }
        .travel-time i {
            margin-right: 5px;
        }

        /* åˆªé™¤æŒ‰éˆ• - ä½¿ç”¨æ–°åƒåœ¾æ¡¶åœ–ç¤ºä¸¦ç¸®å° */
        .delete-btn {
            background: url('https://i.pinimg.com/736x/bc/fb/fe/bcfbfe6f458175b4afd8375a69257cb8.jpg') center/contain no-repeat;
            border: none; width: 30px; height: 30px; /* ç¸®å°ç´„5pt */
            cursor: pointer; margin-left: 20px; flex-shrink: 0;
            transition: all 0.3s; opacity: 0.7;
        }
        .delete-btn:hover { opacity: 1; transform: scale(1.1); }

        /* è¨˜å¸³é …ç›®æ¨£å¼ */
        .account-item {
            background: white; border-radius: var(--radius-sm); padding: 22px; margin-bottom: 18px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid rgba(138, 158, 168, 0.1);
        }

        @media (max-width: 768px) {
            .page, .main-content { padding: 20px 15px; }
            .bottom-nav { padding: 15px 0; }
            .nav-item { padding: 10px 15px; }
        }
        
        /* é é¢å…§å®¹ - ç”¨æ–¼æ–°é é¢é¡¯ç¤º */
        .page-wrapper {
            display: none;
            padding: 25px;
            animation: fadeIn 0.5s ease;
        }
        .page-wrapper.active {
            display: block;
        }
        
        /* æ—…ç¨‹ç°¡ä»‹é é¢æ¨£å¼ */
        .trip-section {
            background: white;
            border-radius: var(--radius-sm);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--primary);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(138, 158, 168, 0.1);
        }
        
        .section-icon {
            font-size: 28px;
            margin-right: 15px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(138, 158, 168, 0.1);
            border-radius: 50%;
        }
        
        .section-title {
            font-size: 22px;
            color: var(--dark);
            font-weight: 700;
        }
        
        .boarding-pass {
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }
        
        .boarding-pass:before {
            content: "";
            position: absolute;
            top: 0;
            left: 30%;
            width: 40%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transform: skewX(-15deg);
        }
        
        .pass-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .pass-airline {
            font-size: 24px;
            font-weight: 700;
        }
        
        .pass-flight {
            font-size: 18px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
        }
        
        .pass-details {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .pass-from, .pass-to {
            text-align: center;
        }
        
        .pass-city {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .pass-airport {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .pass-plane {
            font-size: 30px;
            text-align: center;
        }
        
        .pass-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .pass-info-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .info-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 16px;
            font-weight: 600;
        }
        
        .hotel-card, .car-card {
            background: white;
            border-radius: var(--radius-sm);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(138, 158, 168, 0.1);
        }
        
        .hotel-name, .car-company {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .hotel-address, .car-location {
            color: var(--text-light);
            margin-bottom: 15px;
            font-size: 15px;
        }
        
        .hotel-remarks, .car-remarks {
            padding: 15px;
            background-color: rgba(201, 184, 163, 0.08);
            border-radius: 10px;
            margin-top: 15px;
            font-size: 15px;
            border-left: 3px solid var(--secondary);
        }
        
        .car-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .car-detail-item {
            padding: 10px;
            background-color: rgba(138, 158, 168, 0.05);
            border-radius: 8px;
        }
        
        .other-info-item {
            background: white;
            border-radius: var(--radius-sm);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .other-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .other-content {
            color: var(--text);
            line-height: 1.6;
        }
        
        .edit-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 15px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-btn:hover {
            background: var(--primary);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
            background-color: rgba(138, 158, 168, 0.05);
            border-radius: var(--radius-sm);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #ccc;
        }
        
        /* åœ°åœ–å®¹å™¨ */
        #map-container {
            height: 400px;
            width: 100%;
            border-radius: var(--radius-sm);
            overflow: hidden;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- ç½®ä¸­çš„æ¨™é¡Œæ¡† -->
    <div class="header-title-container">
        <div class="title-container">
            <input type="text" id="app-title" value="âœˆï¸ æˆ‘çš„æ—…è¡Œè¦åŠƒ" maxlength="30" onclick="this.select();">
        </div>
    </div>

    <!-- é é¢1ï¼šè¡Œç¨‹è¦åŠƒ -->
    <div id="itinerary-wrapper" class="page-wrapper active">
        <div id="itinerary-page" class="page-with-bg">
            <!-- èƒŒæ™¯åœ–å±¤èˆ‡è¨­å®šæŒ‰éˆ• -->
            <div id="itinerary-bg-layer" class="page-bg-layer"></div>
            <button class="bg-setting-btn" onclick="toggleBgPanel('itinerary')">âš™ï¸</button>
            <div id="itinerary-bg-panel" class="bg-setting-panel">
                <h4>æ›´æ”¹èƒŒæ™¯åœ–</h4>
                <input type="file" id="itinerary-bg-input" accept="image/*">
                <button onclick="changeBackground('itinerary')">å¥—ç”¨èƒŒæ™¯</button>
            </div>
            <!-- é é¢ä¸»è¦å…§å®¹ -->
            <div class="page-content">
                <h2>ğŸ“… è¡Œç¨‹è¦åŠƒ</h2>
                <div class="input-group">
                    <input type="text" id="activity-input" placeholder="æ´»å‹•åç¨±">
                    <input type="text" id="location-input" placeholder="åœ°é»">
                    <!-- æ—¥æœŸè¼¸å…¥æ¡† - é‚Šæ¡†å·²èª¿æ•´ -->
                    <input type="datetime-local" id="time-input" style="display:block; margin-top:10px; width:100%;">
                    <textarea id="remarks-input" placeholder="å‚™è¨»" rows="3"></textarea>
                    <button class="primary-btn" onclick="addActivity()">æ–°å¢æ´»å‹•</button>
                </div>
                <div id="itinerary-list"></div>
            </div>
        </div>
    </div>

    <!-- é é¢2ï¼šè¡Œç¨‹åœ°åœ– -->
    <div id="map-wrapper" class="page-wrapper">
        <div id="map-page" class="page-with-bg">
            <div id="map-bg-layer" class="page-bg-layer"></div>
            <button class="bg-setting-btn" onclick="toggleBgPanel('map')">âš™ï¸</button>
            <div id="map-bg-panel" class="bg-setting-panel">
                <h4>æ›´æ”¹èƒŒæ™¯åœ–</h4>
                <input type="file" id="map-bg-input" accept="image/*">
                <button onclick="changeBackground('map')">å¥—ç”¨èƒŒæ™¯</button>
            </div>
            <div class="page-content">
                <h2>ğŸ—ºï¸ è¡Œç¨‹åœ°åœ–</h2>
                <div id="map-container">
                    <div id="map"></div>
                </div>
                <div id="locations-list" style="margin-top: 20px;">
                    <h3>è¡Œç¨‹åœ°é»åˆ—è¡¨</h3>
                    <div id="locations-container" style="margin-top: 15px;">
                        <p style="color: var(--text-light); text-align: center; margin-top: 20px; padding: 20px; background: rgba(138, 158, 168, 0.08); border-radius: var(--radius-sm);">
                            è«‹å…ˆåœ¨è¡Œç¨‹é é¢æ·»åŠ æ´»å‹•åœ°é»
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é é¢3ï¼šè¨˜å¸³åŠŸèƒ½ (åŸé ç®—è¦åŠƒ) -->
    <div id="account-wrapper" class="page-wrapper">
        <div id="account-page" class="page-with-bg">
            <div id="account-bg-layer" class="page-bg-layer"></div>
            <button class="bg-setting-btn" onclick="toggleBgPanel('account')">âš™ï¸</button>
            <div id="account-bg-panel" class="bg-setting-panel">
                <h4>æ›´æ”¹èƒŒæ™¯åœ–</h4>
                <input type="file" id="account-bg-input" accept="image/*">
                <button onclick="changeBackground('account')">å¥—ç”¨èƒŒæ™¯</button>
            </div>
            <div class="page-content">
                <h2>ğŸ’° è¨˜å¸³åŠŸèƒ½</h2>
                <div class="input-group">
                    <input type="text" id="expense-name" placeholder="èŠ±è²»é …ç›®åç¨±">
                    <input type="number" id="expense-amount" placeholder="é‡‘é¡">
                    <select id="expense-category">
                        <option value="">é¸æ“‡åˆ†é¡</option>
                        <option value="food">é¤é£²</option>
                        <option value="transportation">äº¤é€š</option>
                        <option value="accommodation">ä½å®¿</option>
                        <option value="shopping">è³¼ç‰©</option>
                        <option value="leisure">ä¼‘é–’å¨›æ¨‚</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                    <input type="date" id="expense-date" placeholder="æ—¥æœŸ">
                    <button class="primary-btn" onclick="addExpense()">è¨˜éŒ„èŠ±è²»</button>
                </div>
                <div id="account-list"></div>
                <div style="text-align: center; padding: 20px; margin-top: 30px; background: rgba(138, 158, 168, 0.08); border-radius: var(--radius-sm);">
                    <h3>ç¸½æ”¯å‡ºçµ±è¨ˆ</h3>
                    <div style="font-size: 32px; font-weight: 700; color: var(--primary); margin: 15px 0;">
                        <span id="total-expense">0</span> å…ƒ
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é é¢4ï¼šæ—…è¡Œç­†è¨˜ -->
    <div id="diary-wrapper" class="page-wrapper">
        <div id="diary-page" class="page-with-bg">
            <div id="diary-bg-layer" class="page-bg-layer"></div>
            <button class="bg-setting-btn" onclick="toggleBgPanel('diary')">âš™ï¸</button>
            <div id="diary-bg-panel" class="bg-setting-panel">
                <h4>æ›´æ”¹èƒŒæ™¯åœ–</h4>
                <input type="file" id="diary-bg-input" accept="image/*">
                <button onclick="changeBackground('diary')">å¥—ç”¨èƒŒæ™¯</button>
            </div>
            <div class="page-content">
                <h2>ğŸ“ æ—…è¡Œç­†è¨˜</h2>
                <div class="input-group">
                    <input type="text" id="diary-title" placeholder="ç­†è¨˜æ¨™é¡Œ">
                    <textarea id="diary-content" placeholder="å¯«ä¸‹æ‚¨çš„ç­†è¨˜..." rows="6"></textarea>
                    <input type="file" id="diary-image" accept="image/*">
                    <button class="primary-btn" onclick="addDiaryEntry()">æ–°å¢ç­†è¨˜</button>
                </div>
                <div id="diary-list"></div>
            </div>
        </div>
    </div>

    <!-- é é¢5ï¼šæ—…ç¨‹ç°¡ä»‹ -->
    <div id="trip-wrapper" class="page-wrapper">
        <div id="trip-page" class="page-with-bg">
            <div id="trip-bg-layer" class="page-bg-layer"></div>
            <button class="bg-setting-btn" onclick="toggleBgPanel('trip')">âš™ï¸</button>
            <div id="trip-bg-panel" class="bg-setting-panel">
                <h4>æ›´æ”¹èƒŒæ™¯åœ–</h4>
                <input type="file" id="trip-bg-input" accept="image/*">
                <button onclick="changeBackground('trip')">å¥—ç”¨èƒŒæ™¯</button>
            </div>
            <div class="page-content">
                <h2>ğŸ“‹ æ—…ç¨‹ç°¡ä»‹</h2>
                
                <!-- èˆªç­è³‡è¨Š -->
                <div class="trip-section">
                    <div class="section-header">
                        <div class="section-icon">âœˆï¸</div>
                        <div class="section-title">èˆªç­è³‡è¨Š</div>
                    </div>
                    <div id="flight-container">
                        <!-- èˆªç­è³‡è¨Šå°‡å‹•æ…‹æ·»åŠ  -->
                        <div class="empty-state">
                            <i class="fas fa-plane"></i>
                            <p>å°šæœªæ·»åŠ èˆªç­è³‡è¨Š</p>
                            <button class="edit-btn" onclick="editFlight()"><i class="fas fa-plus"></i> æ·»åŠ èˆªç­è³‡è¨Š</button>
                        </div>
                    </div>
                </div>
                
                <!-- é…’åº—è³‡è¨Š -->
                <div class="trip-section">
                    <div class="section-header">
                        <div class="section-icon">ğŸ¨</div>
                        <div class="section-title">é…’åº—è³‡è¨Š</div>
                    </div>
                    <div id="hotel-container">
                        <!-- é…’åº—è³‡è¨Šå°‡å‹•æ…‹æ·»åŠ  -->
                        <div class="empty-state">
                            <i class="fas fa-hotel"></i>
                            <p>å°šæœªæ·»åŠ é…’åº—è³‡è¨Š</p>
                            <button class="edit-btn" onclick="editHotel()"><i class="fas fa-plus"></i> æ·»åŠ é…’åº—è³‡è¨Š</button>
                        </div>
                    </div>
                </div>
                
                <!-- ç§Ÿè»Šè³‡è¨Š -->
                <div class="trip-section">
                    <div class="section-header">
                        <div class="section-icon">ğŸš—</div>
                        <div class="section-title">ç§Ÿè»Šè³‡è¨Š</div>
                    </div>
                    <div id="car-container">
                        <!-- ç§Ÿè»Šè³‡è¨Šå°‡å‹•æ…‹æ·»åŠ  -->
                        <div class="empty-state">
                            <i class="fas fa-car"></i>
                            <p>å°šæœªæ·»åŠ ç§Ÿè»Šè³‡è¨Š</p>
                            <button class="edit-btn" onclick="editCar()"><i class="fas fa-plus"></i> æ·»åŠ ç§Ÿè»Šè³‡è¨Š</button>
                        </div>
                    </div>
                </div>
                
                <!-- å…¶ä»–è³‡è¨Š -->
                <div class="trip-section">
                    <div class="section-header">
                        <div class="section-icon">ğŸ“‹</div>
                        <div class="section-title">å…¶ä»–è³‡è¨Š</div>
                    </div>
                    <div id="other-container">
                        <!-- å…¶ä»–è³‡è¨Šå°‡å‹•æ…‹æ·»åŠ  -->
                        <div class="empty-state">
                            <i class="fas fa-info-circle"></i>
                            <p>å°šæœªæ·»åŠ å…¶ä»–è³‡è¨Š</p>
                            <button class="edit-btn" onclick="editOther()"><i class="fas fa-plus"></i> æ·»åŠ å…¶ä»–è³‡è¨Š</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆªåˆ— (æ–°é †åºï¼šè¡Œç¨‹->åœ°åœ–->è¨˜å¸³->ç­†è¨˜->æ—…ç¨‹ç°¡ä»‹) -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="showPage('itinerary')">
            <div class="nav-icon">ğŸ“…</div>
            <div class="nav-text">è¡Œç¨‹</div>
        </div>
        <div class="nav-item" onclick="showPage('map')">
            <div class="nav-icon">ğŸ—ºï¸</div>
            <div class="nav-text">åœ°åœ–</div>
        </div>
        <div class="nav-item" onclick="showPage('account')">
            <div class="nav-icon">ğŸ’°</div>
            <div class="nav-text">è¨˜å¸³</div>
        </div>
        <div class="nav-item" onclick="showPage('diary')">
            <div class="nav-icon">ğŸ“</div>
            <div class="nav-text">ç­†è¨˜</div>
        </div>
        <div class="nav-item" onclick="showPage('trip')">
            <div class="nav-icon">ğŸ“‹</div>
            <div class="nav-text">ç°¡ä»‹</div>
        </div>
    </div>

    <!-- èˆªç­ç·¨è¼¯æ¨¡æ…‹æ¡† -->
    <div id="flight-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
        <div style="background:white; width:90%; max-width:600px; border-radius:var(--radius); padding:30px; max-height:90vh; overflow-y:auto;">
            <h3 style="margin-bottom:20px;">ç·¨è¼¯èˆªç­è³‡è¨Š</h3>
            <div id="flight-form">
                <!-- èˆªç­è¡¨å–®å°‡å‹•æ…‹ç”Ÿæˆ -->
            </div>
            <div style="display:flex; gap:15px; margin-top:25px;">
                <button class="primary-btn" onclick="saveFlight()" style="flex:1;">å„²å­˜èˆªç­è³‡è¨Š</button>
                <button class="edit-btn" onclick="closeModal('flight-modal')" style="background:#6c757d; flex:1;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- é…’åº—ç·¨è¼¯æ¨¡æ…‹æ¡† -->
    <div id="hotel-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
        <div style="background:white; width:90%; max-width:500px; border-radius:var(--radius); padding:30px; max-height:90vh; overflow-y:auto;">
            <h3 style="margin-bottom:20px;">ç·¨è¼¯é…’åº—è³‡è¨Š</h3>
            <div class="input-group">
                <input type="text" id="hotel-name" placeholder="é…’åº—åç¨±">
                <input type="text" id="hotel-address" placeholder="é…’åº—åœ°å€">
                <input type="text" id="hotel-checkin" placeholder="å…¥ä½æ—¥æœŸ (YYYY-MM-DD)">
                <input type="text" id="hotel-checkout" placeholder="é€€æˆ¿æ—¥æœŸ (YYYY-MM-DD)">
                <textarea id="hotel-remarks-input" placeholder="å‚™è¨»" rows="3"></textarea>
            </div>
            <div style="display:flex; gap:15px; margin-top:25px;">
                <button class="primary-btn" onclick="saveHotel()">å„²å­˜é…’åº—è³‡è¨Š</button>
                <button class="edit-btn" onclick="closeModal('hotel-modal')" style="background:#6c757d;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ç§Ÿè»Šç·¨è¼¯æ¨¡æ…‹æ¡† -->
    <div id="car-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
        <div style="background:white; width:90%; max-width:500px; border-radius:var(--radius); padding:30px; max-height:90vh; overflow-y:auto;">
            <h3 style="margin-bottom:20px;">ç·¨è¼¯ç§Ÿè»Šè³‡è¨Š</h3>
            <div class="input-group">
                <input type="text" id="car-company" placeholder="ç§Ÿè»Šå…¬å¸">
                <input type="text" id="car-pickup-location" placeholder="å–è»Šåœ°é»">
                <input type="text" id="car-return-location" placeholder="é‚„è»Šåœ°é»">
                <input type="datetime-local" id="car-pickup-time">
                <input type="datetime-local" id="car-return-time">
                <textarea id="car-remarks-input" placeholder="å‚™è¨»" rows="3"></textarea>
            </div>
            <div style="display:flex; gap:15px; margin-top:25px;">
                <button class="primary-btn" onclick="saveCar()">å„²å­˜ç§Ÿè»Šè³‡è¨Š</button>
                <button class="edit-btn" onclick="closeModal('car-modal')" style="background:#6c757d;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å…¶ä»–è³‡è¨Šç·¨è¼¯æ¨¡æ…‹æ¡† -->
    <div id="other-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
        <div style="background:white; width:90%; max-width:500px; border-radius:var(--radius); padding:30px; max-height:90vh; overflow-y:auto;">
            <h3 style="margin-bottom:20px;">ç·¨è¼¯å…¶ä»–è³‡è¨Š</h3>
            <div class="input-group">
                <input type="text" id="other-title-input" placeholder="æ¨™é¡Œ">
                <textarea id="other-content-input" placeholder="å…§å®¹" rows="6"></textarea>
            </div>
            <div style="display:flex; gap:15px; margin-top:25px;">
                <button class="primary-btn" onclick="saveOther()">å„²å­˜è³‡è¨Š</button>
                <button class="edit-btn" onclick="closeModal('other-modal')" style="background:#6c757d;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== å…¨åŸŸè®Šæ•¸ ====================
        let totalExpense = 0;
        const activities = []; 
        const dateColors = {};
        const expenses = JSON.parse(localStorage.getItem('travelExpenses')) || [];
        const diaryEntries = JSON.parse(localStorage.getItem('travelDiary')) || [];
        const colorPalette = [ 'rgba(163, 201, 184, 0.15)', 'rgba(138, 158, 168, 0.15)', 'rgba(201, 184, 163, 0.15)', 'rgba(168, 138, 153, 0.15)', 'rgba(163, 184, 201, 0.15)' ];
        
        // â˜… æ–°å¢ï¼šæ—…ç¨‹ç°¡ä»‹æ•¸æ“š â˜…
        let tripInfo = JSON.parse(localStorage.getItem('tripInfo')) || {
            flights: [],
            hotels: [],
            cars: [],
            others: []
        };
        
        // â˜… æ–°å¢ï¼šGoogle Maps ç›¸é—œè®Šæ•¸ â˜…
        let map;
        let markers = [];
        let directionsService;
        let directionsRenderer;

        // ==================== é é¢åˆ‡æ›åŠŸèƒ½ (å·²æ”¹ç‚ºè·³è½‰è‡³æ–°é é¢) ====================
        function showPage(pageName) {
            // éš±è—æ‰€æœ‰é é¢
            document.querySelectorAll('.page-wrapper').forEach(wrapper => {
                wrapper.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„é é¢
            document.getElementById(pageName + '-wrapper').classList.add('active');
            
            // æ›´æ–°å°èˆªé¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // æ›´æ–°é é¢æ¨™é¡Œ
            const pageTitles = {
                'itinerary': 'è¡Œç¨‹è¦åŠƒ',
                'map': 'è¡Œç¨‹åœ°åœ–',
                'account': 'è¨˜å¸³åŠŸèƒ½',
                'diary': 'æ—…è¡Œç­†è¨˜',
                'trip': 'æ—…ç¨‹ç°¡ä»‹'
            };
            
            // æ›´æ–°ç€è¦½å™¨æ­·å²è¨˜éŒ„ï¼Œå¯¦ç¾çœŸæ­£çš„é é¢è·³è½‰æ•ˆæœ
            history.pushState({page: pageName}, '', `#${pageName}`);
            
            // åŠ è¼‰è©²é é¢çš„èƒŒæ™¯
            loadBackground(pageName);
            
            // å¦‚æœæ˜¯è¨˜å¸³é é¢ï¼Œæ›´æ–°ç¸½æ”¯å‡º
            if (pageName === 'account') {
                updateExpenseTotal();
            }
            
            // â˜… å¦‚æœæ˜¯åœ°åœ–é é¢ï¼Œåˆå§‹åŒ–åœ°åœ– â˜…
            if (pageName === 'map') {
                setTimeout(() => {
                    if (!map) {
                        initMap();
                    } else {
                        updateMap();
                    }
                }, 100);
            }
            
            // å¦‚æœæ˜¯æ—…ç¨‹ç°¡ä»‹é é¢ï¼Œæ¸²æŸ“å…§å®¹
            if (pageName === 'trip') {
                renderTripInfo();
            }
        }

        // è™•ç†ç€è¦½å™¨å¾Œé€€/å‰é€²æŒ‰éˆ•
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.page) {
                const pageName = event.state.page;
                document.querySelectorAll('.page-wrapper').forEach(wrapper => {
                    wrapper.classList.remove('active');
                });
                document.getElementById(pageName + '-wrapper').classList.add('active');
                
                // æ›´æ–°å°èˆªé¸ä¸­ç‹€æ…‹
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('onclick') === `showPage('${pageName}')`) {
                        item.classList.add('active');
                    }
                });
                
                loadBackground(pageName);
            }
        });

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥URLä¸­çš„hash
        window.addEventListener('load', function() {
            const hash = window.location.hash.substring(1);
            const validPages = ['itinerary', 'map', 'account', 'diary', 'trip'];
            
            if (hash && validPages.includes(hash)) {
                // é¡¯ç¤ºå°æ‡‰é é¢
                document.querySelectorAll('.page-wrapper').forEach(wrapper => {
                    wrapper.classList.remove('active');
                });
                document.getElementById(hash + '-wrapper').classList.add('active');
                
                // æ›´æ–°å°èˆªé¸ä¸­ç‹€æ…‹
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('onclick') === `showPage('${hash}')`) {
                        item.classList.add('active');
                    }
                });
            }
        });

        // ==================== èƒŒæ™¯æ§åˆ¶åŠŸèƒ½ ====================
        function toggleBgPanel(page) {
            const panel = document.getElementById(page + '-bg-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }
        
        function changeBackground(page) {
            const input = document.getElementById(page + '-bg-input');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const bgLayer = document.getElementById(page + '-bg-layer');
                    bgLayer.style.backgroundImage = `url('${e.target.result}')`;
                    localStorage.setItem(page + '_bg', e.target.result);
                    document.getElementById(page + '-bg-panel').style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function loadBackground(page) {
            const savedBg = localStorage.getItem(page + '_bg');
            if (savedBg) {
                document.getElementById(page + '-bg-layer').style.backgroundImage = `url('${savedBg}')`;
            }
        }

        // ==================== è¡Œç¨‹è¦åŠƒåŠŸèƒ½ ====================
        function addActivity() {
            const activity = document.getElementById('activity-input').value;
            const location = document.getElementById('location-input').value;
            const timeValue = document.getElementById('time-input').value;
            const remarks = document.getElementById('remarks-input').value;

            if (!activity || !location) { 
                alert('è«‹å¡«å¯«æ´»å‹•åç¨±å’Œåœ°é»'); 
                return; 
            }

            let displayDate = 'æœªè¨­å®šæ—¥æœŸ';
            if (timeValue) {
                const dateObj = new Date(timeValue);
                displayDate = dateObj.toLocaleDateString('zh-TW', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                });
            }

            const activityObj = { 
                id: Date.now(), 
                title: activity, 
                location: location, 
                time: timeValue,
                displayDate: displayDate,
                remarks: remarks,
                travelTime: null // â˜… æ–°å¢ï¼šå„²å­˜äº¤é€šæ™‚é–“ â˜…
            };
            
            activities.push(activityObj); 
            renderItinerary(); 
            updateMapLocations(); 
            saveToLocalStorage();
            
            // â˜… æ–°å¢ï¼šè¨ˆç®—äº¤é€šæ™‚é–“ â˜…
            calculateTravelTimes();

            document.getElementById('activity-input').value = '';
            document.getElementById('location-input').value = '';
            document.getElementById('time-input').value = '';
            document.getElementById('remarks-input').value = '';

            alert('æ´»å‹•å·²æ–°å¢ï¼');
        }
        
        function deleteActivity(id) {
            const index = activities.findIndex(a => a.id === id);
            if (index !== -1) { 
                activities.splice(index, 1); 
                renderItinerary(); 
                updateMapLocations(); 
                saveToLocalStorage(); 
                
                // â˜… æ–°å¢ï¼šé‡æ–°è¨ˆç®—äº¤é€šæ™‚é–“ â˜…
                calculateTravelTimes();
            }
        }
        
        function renderItinerary() {
            const listContainer = document.getElementById('itinerary-list');
            listContainer.innerHTML = '';
            
            if (activities.length === 0) {
                listContainer.innerHTML = '<div style="text-align:center; padding:30px; color:#666;">å°šæœªæ·»åŠ ä»»ä½•è¡Œç¨‹</div>';
                return;
            }

            // æŒ‰æ—¥æœŸåˆ†çµ„æ´»å‹•
            const activitiesByDate = {};
            activities.forEach(activity => {
                const dateKey = activity.displayDate || 'æœªè¨­å®šæ—¥æœŸ';
                if (!activitiesByDate[dateKey]) activitiesByDate[dateKey] = [];
                activitiesByDate[dateKey].push(activity);
            });

            // ç‚ºæ¯å€‹æ—¥æœŸåˆ†é…é¡è‰²
            Object.keys(activitiesByDate).forEach((dateKey, index) => {
                if (!dateColors[dateKey]) dateColors[dateKey] = colorPalette[index % colorPalette.length];
            });

            // æ¸²æŸ“æ¯å€‹æ—¥æœŸå€å¡Š
            Object.keys(activitiesByDate).forEach(dateKey => {
                const dateSection = document.createElement('div');
                dateSection.className = 'date-section';
                dateSection.style.backgroundColor = dateColors[dateKey];
                
                dateSection.innerHTML = `<div class="date-header">${dateKey}</div><div class="sortable-list" id="sortable-${dateKey.replace(/\s+/g, '-')}"></div>`;
                listContainer.appendChild(dateSection);
                const sortableList = dateSection.querySelector(`#sortable-${dateKey.replace(/\s+/g, '-')}`);
                
                activitiesByDate[dateKey].forEach(activity => {
                    sortableList.appendChild(createActivityElement(activity));
                });
                
                // â˜… ä¿®æ”¹ï¼šæ’åºçµæŸæ™‚é‡æ–°è¨ˆç®—äº¤é€šæ™‚é–“ â˜…
                new Sortable(sortableList, { 
                    animation: 150, 
                    ghostClass: 'sortable-ghost', 
                    onEnd: function() {
                        saveToLocalStorage();
                        calculateTravelTimes();
                    }
                });
            });
        }
        
        function createActivityElement(activity) {
            const div = document.createElement('div'); 
            div.className = 'itinerary-item'; 
            div.setAttribute('data-id', activity.id);
            
            // â˜… æ–°å¢ï¼šäº¤é€šæ™‚é–“é¡¯ç¤º â˜…
            let travelTimeHtml = '';
            if (activity.travelTime) {
                travelTimeHtml = `<div class="travel-time"><i class="fas fa-car"></i> é è¨ˆäº¤é€šæ™‚é–“: ${activity.travelTime}</div>`;
            }
            
            div.innerHTML = `<div class="item-content">
                                <div class="item-header">
                                    <div class="item-title">${activity.title}</div>
                                    <div class="item-time">${activity.displayDate}</div>
                                </div>
                                <div class="item-location">ğŸ“ ${activity.location}</div>
                                ${travelTimeHtml}
                                ${activity.remarks ? `<div class="item-remarks">ğŸ“ ${activity.remarks}</div>` : ''}
                             </div>
                             <button class="delete-btn" onclick="deleteActivity(${activity.id})" title="åˆªé™¤"></button>`;
            return div;
        }

        // ==================== Google Maps ç›¸é—œåŠŸèƒ½ ====================
        // â˜… APIä½ç½®ï¼šGoogle Maps APIåˆå§‹åŒ– â˜…
        function initMap() {
            // è¨­ç½®é»˜èªä¸­å¿ƒé»
            const defaultCenter = { lat: 25.0330, lng: 121.5654 }; // å°åŒ—
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultCenter,
                zoom: 12,
                styles: [
                    {
                        featureType: "all",
                        elementType: "geometry",
                        stylers: [{ color: "#f5f5f5" }]
                    },
                    {
                        featureType: "water",
                        elementType: "geometry",
                        stylers: [{ color: "#c3d7df" }]
                    }
                ]
            });
            
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);
            
            updateMap();
        }
        
        function updateMap() {
            if (!map) return;
            
            // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            // æ·»åŠ æ´»å‹•åœ°é»æ¨™è¨˜
            activities.forEach((activity, index) => {
                if (!activity.location || activity.location.trim() === '') return;
                
                // ä½¿ç”¨Geocoderå°‡åœ°å€è½‰æ›ç‚ºåº§æ¨™
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: activity.location }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const position = results[0].geometry.location;
                        
                        const marker = new google.maps.Marker({
                            map: map,
                            position: position,
                            title: activity.title,
                            label: {
                                text: (index + 1).toString(),
                                color: 'white',
                                fontWeight: 'bold'
                            },
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 14,
                                fillColor: '#4b6cb7',
                                fillOpacity: 1,
                                strokeColor: 'white',
                                strokeWeight: 2
                            }
                        });
                        
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<div style="padding:12px; max-width:250px;">
                                        <h3 style="margin:0 0 8px 0; color:var(--primary);">${activity.title}</h3>
                                        <p style="margin:0 0 5px 0; font-size:14px; color:#666;">ğŸ“ ${activity.location}</p>
                                        ${activity.displayDate ? `<p style="margin:0 0 5px 0; font-size:14px;">ğŸ“… ${activity.displayDate}</p>` : ''}
                                        ${activity.travelTime ? `<p style="margin:0 0 5px 0; font-size:14px;">ğŸš— ${activity.travelTime}</p>` : ''}
                                        ${activity.remarks ? `<p style="margin:0; font-size:14px;">ğŸ“ ${activity.remarks.substring(0, 50)}${activity.remarks.length > 50 ? '...' : ''}</p>` : ''}
                                      </div>`
                        });
                        
                        marker.addListener('click', () => {
                            infoWindow.open(map, marker);
                        });
                        
                        markers.push(marker);
                    }
                });
            });
            
            // æ·»åŠ é…’åº—æ¨™è¨˜
            tripInfo.hotels.forEach((hotel, index) => {
                if (!hotel.address || hotel.address.trim() === '') return;
                
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: hotel.address }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const position = results[0].geometry.location;
                        
                        const marker = new google.maps.Marker({
                            map: map,
                            position: position,
                            title: hotel.name,
                            icon: {
                                url: "https://maps.google.com/mapfiles/ms/icons/lodging.png",
                                scaledSize: new google.maps.Size(32, 32)
                            }
                        });
                        
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<div style="padding:12px; max-width:250px;">
                                        <h3 style="margin:0 0 8px 0; color:var(--primary);">ğŸ¨ ${hotel.name}</h3>
                                        <p style="margin:0 0 5px 0; font-size:14px; color:#666;">ğŸ“ ${hotel.address}</p>
                                        ${hotel.checkin ? `<p style="margin:0 0 5px 0; font-size:14px;">ğŸ“… å…¥ä½: ${hotel.checkin}</p>` : ''}
                                        ${hotel.checkout ? `<p style="margin:0 0 5px 0; font-size:14px;">ğŸ“… é€€æˆ¿: ${hotel.checkout}</p>` : ''}
                                        ${hotel.remarks ? `<p style="margin:0; font-size:14px;">ğŸ“ ${hotel.remarks.substring(0, 50)}${hotel.remarks.length > 50 ? '...' : ''}</p>` : ''}
                                      </div>`
                        });
                        
                        marker.addListener('click', () => {
                            infoWindow.open(map, marker);
                        });
                        
                        markers.push(marker);
                    }
                });
            });
            
            // æ·»åŠ ç§Ÿè»Šåœ°é»æ¨™è¨˜
            tripInfo.cars.forEach((car, index) => {
                if (!car.pickupLocation || car.pickupLocation.trim() === '') return;
                
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: car.pickupLocation }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const position = results[0].geometry.location;
                        
                        const marker = new google.maps.Marker({
                            map: map,
                            position: position,
                            title: `${car.company} - å–è»Šé»`,
                            icon: {
                                url: "https://maps.google.com/mapfiles/ms/icons/car.png",
                                scaledSize: new google.maps.Size(32, 32)
                            }
                        });
                        
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<div style="padding:12px; max-width:250px;">
                                        <h3 style="margin:0 0 8px 0; color:var(--primary);">ğŸš— ${car.company}</h3>
                                        <p style="margin:0 0 5px 0; font-size:14px; color:#666;">ğŸ“ å–è»Š: ${car.pickupLocation}</p>
                                        ${car.returnLocation ? `<p style="margin:0 0 5px 0; font-size:14px;">ğŸ“ é‚„è»Š: ${car.returnLocation}</p>` : ''}
                                        ${car.pickupTime ? `<p style="margin:0 0 5px 0; font-size:14px;">ğŸ“… å–è»Šæ™‚é–“: ${formatDateTime(car.pickupTime)}</p>` : ''}
                                        ${car.returnTime ? `<p style="margin:0 0 5px 0; font-size:14px;">ğŸ“… é‚„è»Šæ™‚é–“: ${formatDateTime(car.returnTime)}</p>` : ''}
                                        ${car.remarks ? `<p style="margin:0; font-size:14px;">ğŸ“ ${car.remarks.substring(0, 50)}${car.remarks.length > 50 ? '...' : ''}</p>` : ''}
                                      </div>`
                        });
                        
                        marker.addListener('click', () => {
                            infoWindow.open(map, marker);
                        });
                        
                        markers.push(marker);
                    }
                });
            });
        }
        
        // â˜… APIä½ç½®ï¼šè¨ˆç®—äº¤é€šæ™‚é–“å‡½æ•¸ â˜…
        function calculateTravelTimes() {
            if (!directionsService || activities.length < 2) return;
            
            // ç‚ºæ¯å€‹æ´»å‹•è¨ˆç®—å¾ä¸Šä¸€å€‹åœ°é»åˆ°ç•¶å‰åœ°é»çš„äº¤é€šæ™‚é–“
            for (let i = 1; i < activities.length; i++) {
                const prevActivity = activities[i - 1];
                const currentActivity = activities[i];
                
                if (!prevActivity.location || !currentActivity.location) continue;
                
                const request = {
                    origin: prevActivity.location,
                    destination: currentActivity.location,
                    travelMode: 'DRIVING',
                    drivingOptions: {
                        departureTime: new Date(),
                        trafficModel: 'bestguess'
                    }
                };
                
                directionsService.route(request, (result, status) => {
                    if (status === 'OK') {
                        const duration = result.routes[0].legs[0].duration.text;
                        currentActivity.travelTime = duration;
                        
                        // æ›´æ–°é¡¯ç¤º
                        renderItinerary();
                        saveToLocalStorage();
                    }
                });
            }
        }
        
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '';
            const date = new Date(dateTimeStr);
            return date.toLocaleString('zh-TW');
        }

        // ==================== åœ°åœ–é é¢åŠŸèƒ½ ====================
        function updateMapLocations() {
            const locationsContainer = document.getElementById('locations-container');
            locationsContainer.innerHTML = '';
            
            if (activities.length === 0) {
                locationsContainer.innerHTML = '<p style="color: var(--text-light); text-align: center; margin-top: 20px; padding: 20px; background: rgba(138, 158, 168, 0.08); border-radius: var(--radius-sm);">è«‹å…ˆåœ¨è¡Œç¨‹é é¢æ·»åŠ æ´»å‹•åœ°é»</p>';
                return;
            }
            
            activities.forEach((activity, index) => {
                if (!activity.location || activity.location.trim() === '') return;
                
                const locationItem = document.createElement('div');
                locationItem.className = 'account-item';
                locationItem.style.cursor = 'default';
                
                let travelTimeHtml = '';
                if (activity.travelTime) {
                    travelTimeHtml = `<div style="margin-top: 8px;"><span style="background-color: rgba(163, 201, 184, 0.2); padding: 3px 8px; border-radius: 12px; font-size: 12px;">ğŸš— ${activity.travelTime}</span></div>`;
                }
                
                locationItem.innerHTML = `
                    <div>
                        <div style="font-weight:bold;">${index + 1}. ${activity.title}</div>
                        <div style="font-size:14px;color:var(--text-light);">ğŸ“ ${activity.location}</div>
                        ${activity.displayDate ? `<div style="font-size:14px;color:var(--primary); margin-top:5px;">${activity.displayDate}</div>` : ''}
                        ${travelTimeHtml}
                    </div>
                    <div>
                        ${activity.remarks ? `<div style="background: rgba(163, 201, 184, 0.2); padding: 5px 12px; border-radius: 20px; font-size: 12px; color: var(--dark);">æœ‰å‚™è¨»</div>` : ''}
                    </div>
                `;
                locationsContainer.appendChild(locationItem);
            });
        }

        // ==================== è¨˜å¸³åŠŸèƒ½ ====================
        function addExpense() {
            const name = document.getElementById('expense-name').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const category = document.getElementById('expense-category').value;
            const date = document.getElementById('expense-date').value || new Date().toISOString().split('T')[0];
            
            if (!name || !amount || !category) { 
                alert('è«‹å¡«å¯«èŠ±è²»é …ç›®ã€é‡‘é¡å’Œåˆ†é¡'); 
                return; 
            }
            
            const expense = { 
                id: Date.now(), 
                name, 
                amount, 
                category, 
                date,
                formattedDate: new Date(date).toLocaleDateString('zh-TW')
            };
            
            expenses.push(expense); 
            totalExpense += amount; 
            renderExpenses(); 
            updateExpenseTotal();
            saveExpensesToLocalStorage();
            
            document.getElementById('expense-name').value = '';
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-category').value = '';
            document.getElementById('expense-date').value = '';
            
            alert('èŠ±è²»å·²è¨˜éŒ„ï¼');
        }
        
        function deleteExpense(id) {
            const index = expenses.findIndex(exp => exp.id === id);
            if (index !== -1) { 
                totalExpense -= expenses[index].amount; 
                expenses.splice(index, 1); 
                renderExpenses(); 
                updateExpenseTotal();
                saveExpensesToLocalStorage(); 
            }
        }
        
        function updateExpenseTotal() {
            totalExpense = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            document.getElementById('total-expense').textContent = totalExpense.toLocaleString();
        }
        
        function renderExpenses() {
            const list = document.getElementById('account-list'); 
            list.innerHTML = '';
            
            if (expenses.length === 0) { 
                list.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">å°šæœªè¨˜éŒ„ä»»ä½•èŠ±è²»</div>'; 
                return; 
            }
            
            // æŒ‰æ—¥æœŸæ’åºï¼Œæœ€æ–°çš„åœ¨å‰
            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedExpenses.forEach(expense => {
                const item = document.createElement('div'); 
                item.className = 'account-item';
                
                const categoryNames = { 
                    'food':'é¤é£²', 
                    'transportation':'äº¤é€š', 
                    'accommodation':'ä½å®¿',
                    'shopping':'è³¼ç‰©', 
                    'leisure':'ä¼‘é–’å¨›æ¨‚',
                    'other':'å…¶ä»–' 
                };
                
                const categoryColors = {
                    'food': '#e1f5fe',
                    'transportation': '#f3e5f5',
                    'accommodation': '#e8f5e8',
                    'shopping': '#fff3e0',
                    'leisure': '#fce4ec',
                    'other': '#f5f5f5'
                };
                
                const categoryTextColors = {
                    'food': '#0277bd',
                    'transportation': '#7b1fa2',
                    'accommodation': '#2e7d32',
                    'shopping': '#ef6c00',
                    'leisure': '#c2185b',
                    'other': '#616161'
                };
                
                item.innerHTML = `
                    <div>
                        <div style="font-weight:bold;">${expense.name}</div>
                        <div style="font-size:14px;color:var(--text-light);">${expense.formattedDate || expense.date}</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div style="padding:5px 12px; border-radius:20px; font-size:12px; font-weight:bold; 
                             background:${categoryColors[expense.category] || '#f5f5f5'}; 
                             color:${categoryTextColors[expense.category] || '#616161'}">
                            ${categoryNames[expense.category] || expense.category}
                        </div>
                        <div style="font-weight:bold;color:#EA5455;font-size:20px;">${expense.amount.toLocaleString()} å…ƒ</div>
                        <button class="delete-btn" onclick="deleteExpense(${expense.id})" title="åˆªé™¤"></button>
                    </div>`;
                list.appendChild(item);
            });
        }

        // ==================== ç­†è¨˜åŠŸèƒ½ ====================
        function addDiaryEntry() {
            const title = document.getElementById('diary-title').value;
            const content = document.getElementById('diary-content').value;
            const imageInput = document.getElementById('diary-image');
            
            if (!title || !content) { 
                alert('è«‹å¡«å¯«æ¨™é¡Œå’Œå…§å®¹'); 
                return; 
            }
            
            const entry = { 
                id: Date.now(), 
                title, 
                content, 
                date: new Date().toLocaleString('zh-TW'), 
                image: null 
            };
            
            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { 
                    entry.image = e.target.result; 
                    diaryEntries.unshift(entry); 
                    renderDiaryEntries(); 
                    saveDiaryToLocalStorage(); 
                    resetDiaryForm(); 
                    alert('ç­†è¨˜å·²æ–°å¢ï¼'); 
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else { 
                diaryEntries.unshift(entry); 
                renderDiaryEntries(); 
                saveDiaryToLocalStorage(); 
                resetDiaryForm(); 
                alert('ç­†è¨˜å·²æ–°å¢ï¼'); 
            }
        }
        
        function deleteDiaryEntry(id) {
            const index = diaryEntries.findIndex(entry => entry.id === id);
            if (index !== -1) { 
                diaryEntries.splice(index, 1); 
                renderDiaryEntries(); 
                saveDiaryToLocalStorage(); 
            }
        }
        
        function renderDiaryEntries() {
            const list = document.getElementById('diary-list'); 
            list.innerHTML = '';
            
            if (diaryEntries.length === 0) { 
                list.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">å°šæœªæ’°å¯«ä»»ä½•ç­†è¨˜</div>'; 
                return; 
            }
            
            diaryEntries.forEach(entry => {
                const entryEl = document.createElement('div'); 
                entryEl.className = 'account-item';
                entryEl.style.flexDirection = 'column';
                entryEl.style.alignItems = 'flex-start';
                
                let imageHTML = ''; 
                if (entry.image) { 
                    imageHTML = `<img src="${entry.image}" alt="ç­†è¨˜åœ–ç‰‡" style="max-width:100%; border-radius:var(--radius-sm); margin-top:15px;">`; 
                }
                
                entryEl.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; width:100%;">
                        <div style="flex-grow:1;">
                            <div style="font-weight:bold;font-size:20px;margin-bottom:10px;color:var(--dark);">${entry.title}</div>
                            <div style="font-size:14px; color:#7f8c8d;">ğŸ“… ${entry.date}</div>
                        </div>
                        <button class="delete-btn" onclick="deleteDiaryEntry(${entry.id})" title="åˆªé™¤"></button>
                    </div>
                    <div style="margin-top:15px; line-height:1.8; width:100%;">${entry.content.replace(/\n/g, '<br>')}</div>
                    ${imageHTML}`;
                list.appendChild(entryEl);
            });
        }
        
        function resetDiaryForm() {
            document.getElementById('diary-title').value = '';
            document.getElementById('diary-content').value = '';
            document.getElementById('diary-image').value = '';
        }

        // ==================== æ—…ç¨‹ç°¡ä»‹åŠŸèƒ½ ====================
        function renderTripInfo() {
            renderFlights();
            renderHotels();
            renderCars();
            renderOthers();
        }
        
        function renderFlights() {
            const container = document.getElementById('flight-container');
            
            if (tripInfo.flights.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-plane"></i>
                        <p>å°šæœªæ·»åŠ èˆªç­è³‡è¨Š</p>
                        <button class="edit-btn" onclick="editFlight()"><i class="fas fa-plus"></i> æ·»åŠ èˆªç­è³‡è¨Š</button>
                    </div>`;
                return;
            }
            
            let flightsHtml = '';
            tripInfo.flights.forEach((flight, index) => {
                flightsHtml += `
                    <div class="boarding-pass" style="margin-bottom: 20px;">
                        <div class="pass-header">
                            <div class="pass-airline">${flight.airline || 'èˆªç©ºå…¬å¸'}</div>
                            <div class="pass-flight">${flight.flightNumber || 'èˆªç­è™Ÿç¢¼'}</div>
                        </div>
                        <div class="pass-details">
                            <div class="pass-from">
                                <div class="pass-city">${flight.departureCity || 'å‡ºç™¼åŸå¸‚'}</div>
                                <div class="pass-airport">${flight.departureAirport || 'æ©Ÿå ´'}</div>
                                <div style="margin-top: 10px; font-size: 18px; font-weight: 700;">${formatFlightTime(flight.departureTime)}</div>
                            </div>
                            <div class="pass-plane">âœˆï¸</div>
                            <div class="pass-to">
                                <div class="pass-city">${flight.arrivalCity || 'åˆ°é”åŸå¸‚'}</div>
                                <div class="pass-airport">${flight.arrivalAirport || 'æ©Ÿå ´'}</div>
                                <div style="margin-top: 10px; font-size: 18px; font-weight: 700;">${formatFlightTime(flight.arrivalTime)}</div>
                            </div>
                        </div>
                        <div class="pass-info">
                            <div class="pass-info-item">
                                <div class="info-label">æ—¥æœŸ</div>
                                <div class="info-value">${flight.date || 'æœªè¨­å®š'}</div>
                            </div>
                            <div class="pass-info-item">
                                <div class="info-label">è‰™ç­‰</div>
                                <div class="info-value">${flight.class || 'ç¶“æ¿Ÿè‰™'}</div>
                            </div>
                            <div class="pass-info-item">
                                <div class="info-label">åº§ä½</div>
                                <div class="info-value">${flight.seat || 'æœªæŒ‡å®š'}</div>
                            </div>
                        </div>
                        ${flight.remarks ? `<div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 14px;">ğŸ“ ${flight.remarks}</div>` : ''}
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="edit-btn" onclick="editFlight(${flight.id})" style="background: var(--primary);"><i class="fas fa-edit"></i> ç·¨è¼¯</button>
                            <button class="edit-btn" onclick="deleteFlight(${flight.id})" style="background: #EA5455;"><i class="fas fa-trash"></i> åˆªé™¤</button>
                        </div>
                    </div>`;
            });
            
            container.innerHTML = flightsHtml + `<button class="edit-btn" onclick="editFlight()" style="margin-top: 15px;"><i class="fas fa-plus"></i> æ·»åŠ å¦ä¸€èˆªç­</button>`;
        }
        
        function renderHotels() {
            const container = document.getElementById('hotel-container');
            
            if (tripInfo.hotels.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-hotel"></i>
                        <p>å°šæœªæ·»åŠ é…’åº—è³‡è¨Š</p>
                        <button class="edit-btn" onclick="editHotel()"><i class="fas fa-plus"></i> æ·»åŠ é…’åº—è³‡è¨Š</button>
                    </div>`;
                return;
            }
            
            let hotelsHtml = '';
            tripInfo.hotels.forEach((hotel, index) => {
                hotelsHtml += `
                    <div class="hotel-card">
                        <div class="hotel-name">${hotel.name || 'æœªå‘½åé…’åº—'}</div>
                        <div class="hotel-address">ğŸ“ ${hotel.address || 'æœªè¨­å®šåœ°å€'}</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                            <div style="padding: 10px; background-color: rgba(138, 158, 168, 0.05); border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-light);">å…¥ä½</div>
                                <div style="font-weight: 600;">${hotel.checkin || 'æœªè¨­å®š'}</div>
                            </div>
                            <div style="padding: 10px; background-color: rgba(138, 158, 168, 0.05); border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-light);">é€€æˆ¿</div>
                                <div style="font-weight: 600;">${hotel.checkout || 'æœªè¨­å®š'}</div>
                            </div>
                        </div>
                        ${hotel.remarks ? `<div class="hotel-remarks">ğŸ“ ${hotel.remarks}</div>` : ''}
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="edit-btn" onclick="editHotel(${hotel.id})"><i class="fas fa-edit"></i> ç·¨è¼¯</button>
                            <button class="edit-btn" onclick="deleteHotel(${hotel.id})" style="background: #EA5455;"><i class="fas fa-trash"></i> åˆªé™¤</button>
                        </div>
                    </div>`;
            });
            
            container.innerHTML = hotelsHtml + `<button class="edit-btn" onclick="editHotel()" style="margin-top: 15px;"><i class="fas fa-plus"></i> æ·»åŠ å¦ä¸€é…’åº—</button>`;
        }
        
        function renderCars() {
            const container = document.getElementById('car-container');
            
            if (tripInfo.cars.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-car"></i>
                        <p>å°šæœªæ·»åŠ ç§Ÿè»Šè³‡è¨Š</p>
                        <button class="edit-btn" onclick="editCar()"><i class="fas fa-plus"></i> æ·»åŠ ç§Ÿè»Šè³‡è¨Š</button>
                    </div>`;
                return;
            }
            
            let carsHtml = '';
            tripInfo.cars.forEach((car, index) => {
                carsHtml += `
                    <div class="car-card">
                        <div class="car-company">${car.company || 'ç§Ÿè»Šå…¬å¸'}</div>
                        <div class="car-details">
                            <div class="car-detail-item">
                                <div style="font-size: 12px; color: var(--text-light);">å–è»Šåœ°é»</div>
                                <div style="font-weight: 600;">${car.pickupLocation || 'æœªè¨­å®š'}</div>
                            </div>
                            <div class="car-detail-item">
                                <div style="font-size: 12px; color: var(--text-light);">é‚„è»Šåœ°é»</div>
                                <div style="font-weight: 600;">${car.returnLocation || 'æœªè¨­å®š'}</div>
                            </div>
                            <div class="car-detail-item">
                                <div style="font-size: 12px; color: var(--text-light);">å–è»Šæ™‚é–“</div>
                                <div style="font-weight: 600;">${formatDateTime(car.pickupTime) || 'æœªè¨­å®š'}</div>
                            </div>
                            <div class="car-detail-item">
                                <div style="font-size: 12px; color: var(--text-light);">é‚„è»Šæ™‚é–“</div>
                                <div style="font-weight: 600;">${formatDateTime(car.returnTime) || 'æœªè¨­å®š'}</div>
                            </div>
                        </div>
                        ${car.remarks ? `<div class="car-remarks">ğŸ“ ${car.remarks}</div>` : ''}
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="edit-btn" onclick="editCar(${car.id})"><i class="fas fa-edit"></i> ç·¨è¼¯</button>
                            <button class="edit-btn" onclick="deleteCar(${car.id})" style="background: #EA5455;"><i class="fas fa-trash"></i> åˆªé™¤</button>
                        </div>
                    </div>`;
            });
            
            container.innerHTML = carsHtml + `<button class="edit-btn" onclick="editCar()" style="margin-top: 15px;"><i class="fas fa-plus"></i> æ·»åŠ å¦ä¸€ç§Ÿè»Š</button>`;
        }
        
        function renderOthers() {
            const container = document.getElementById('other-container');
            
            if (tripInfo.others.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-info-circle"></i>
                        <p>å°šæœªæ·»åŠ å…¶ä»–è³‡è¨Š</p>
                        <button class="edit-btn" onclick="editOther()"><i class="fas fa-plus"></i> æ·»åŠ å…¶ä»–è³‡è¨Š</button>
                    </div>`;
                return;
            }
            
            let othersHtml = '';
            tripInfo.others.forEach((other, index) => {
                othersHtml += `
                    <div class="other-info-item">
                        <div class="other-title">${other.title || 'æœªå‘½å'}</div>
                        <div class="other-content">${other.content.replace(/\n/g, '<br>') || 'ç„¡å…§å®¹'}</div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="edit-btn" onclick="editOther(${other.id})"><i class="fas fa-edit"></i> ç·¨è¼¯</button>
                            <button class="edit-btn" onclick="deleteOther(${other.id})" style="background: #EA5455;"><i class="fas fa-trash"></i> åˆªé™¤</button>
                        </div>
                    </div>`;
            });
            
            container.innerHTML = othersHtml + `<button class="edit-btn" onclick="editOther()" style="margin-top: 15px;"><i class="fas fa-plus"></i> æ·»åŠ å…¶ä»–è³‡è¨Š</button>`;
        }
        
        function formatFlightTime(timeStr) {
            if (!timeStr) return '--:--';
            const date = new Date(timeStr);
            return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
        }
        
        // èˆªç­ç·¨è¼¯åŠŸèƒ½
        let editingFlightId = null;
        
        function editFlight(id = null) {
            editingFlightId = id;
            const flightForm = document.getElementById('flight-form');
            
            // å¦‚æœæ˜¯ç·¨è¼¯ç¾æœ‰èˆªç­ï¼Œç²å–èˆªç­æ•¸æ“š
            let flightData = { isRoundTrip: true };
            if (id) {
                const flight = tripInfo.flights.find(f => f.id === id);
                if (flight) flightData = flight;
            }
            
            flightForm.innerHTML = `
                <div class="input-group">
                    <label style="display:block; margin-bottom:5px; font-weight:600;">èˆªç­é¡å‹</label>
                    <select id="flight-type" style="margin-bottom:15px;" onchange="toggleRoundTrip()">
                        <option value="roundtrip" ${flightData.isRoundTrip ? 'selected' : ''}>ä¾†å›èˆªç­</option>
                        <option value="oneway" ${!flightData.isRoundTrip ? 'selected' : ''}>å–®ç¨‹èˆªç­</option>
                    </select>
                    
                    <div id="outbound-flight">
                        <h4 style="margin:20px 0 10px 0; color:var(--dark);">å»ç¨‹èˆªç­</h4>
                        <input type="text" id="outbound-airline" placeholder="èˆªç©ºå…¬å¸" value="${flightData.outboundAirline || ''}">
                        <input type="text" id="outbound-flight-number" placeholder="èˆªç­è™Ÿç¢¼" value="${flightData.outboundFlightNumber || ''}">
                        <input type="text" id="outbound-departure-city" placeholder="å‡ºç™¼åŸå¸‚" value="${flightData.outboundDepartureCity || ''}">
                        <input type="text" id="outbound-departure-airport" placeholder="å‡ºç™¼æ©Ÿå ´" value="${flightData.outboundDepartureAirport || ''}">
                        <input type="datetime-local" id="outbound-departure-time" value="${flightData.outboundDepartureTime || ''}">
                        <input type="text" id="outbound-arrival-city" placeholder="åˆ°é”åŸå¸‚" value="${flightData.outboundArrivalCity || ''}">
                        <input type="text" id="outbound-arrival-airport" placeholder="åˆ°é”æ©Ÿå ´" value="${flightData.outboundArrivalAirport || ''}">
                        <input type="datetime-local" id="outbound-arrival-time" value="${flightData.outboundArrivalTime || ''}">
                        <input type="date" id="outbound-date" placeholder="æ—¥æœŸ" value="${flightData.outboundDate || ''}">
                        <input type="text" id="outbound-class" placeholder="è‰™ç­‰ (å¦‚: ç¶“æ¿Ÿè‰™)" value="${flightData.outboundClass || ''}">
                        <input type="text" id="outbound-seat" placeholder="åº§ä½è™Ÿç¢¼" value="${flightData.outboundSeat || ''}">
                        <textarea id="outbound-remarks" placeholder="å‚™è¨»" rows="2">${flightData.outboundRemarks || ''}</textarea>
                    </div>
                    
                    <div id="inbound-flight" style="${flightData.isRoundTrip ? '' : 'display:none;'}">
                        <h4 style="margin:20px 0 10px 0; color:var(--dark);">å›ç¨‹èˆªç­</h4>
                        <input type="text" id="inbound-airline" placeholder="èˆªç©ºå…¬å¸" value="${flightData.inboundAirline || ''}">
                        <input type="text" id="inbound-flight-number" placeholder="èˆªç­è™Ÿç¢¼" value="${flightData.inboundFlightNumber || ''}">
                        <input type="text" id="inbound-departure-city" placeholder="å‡ºç™¼åŸå¸‚" value="${flightData.inboundDepartureCity || ''}">
                        <input type="text" id="inbound-departure-airport" placeholder="å‡ºç™¼æ©Ÿå ´" value="${flightData.inboundDepartureAirport || ''}">
                        <input type="datetime-local" id="inbound-departure-time" value="${flightData.inboundDepartureTime || ''}">
                        <input type="text" id="inbound-arrival-city" placeholder="åˆ°é”åŸå¸‚" value="${flightData.inboundArrivalCity || ''}">
                        <input type="text" id="inbound-arrival-airport" placeholder="åˆ°é”æ©Ÿå ´" value="${flightData.inboundArrivalAirport || ''}">
                        <input type="datetime-local" id="inbound-arrival-time" value="${flightData.inboundArrivalTime || ''}">
                        <input type="date" id="inbound-date" placeholder="æ—¥æœŸ" value="${flightData.inboundDate || ''}">
                        <input type="text" id="inbound-class" placeholder="è‰™ç­‰ (å¦‚: ç¶“æ¿Ÿè‰™)" value="${flightData.inboundClass || ''}">
                        <input type="text" id="inbound-seat" placeholder="åº§ä½è™Ÿç¢¼" value="${flightData.inboundSeat || ''}">
                        <textarea id="inbound-remarks" placeholder="å‚™è¨»" rows="2">${flightData.inboundRemarks || ''}</textarea>
                    </div>
                    
                    <textarea id="flight-general-remarks" placeholder="èˆªç­é€šç”¨å‚™è¨»" rows="2">${flightData.remarks || ''}</textarea>
                </div>`;
            
            document.getElementById('flight-modal').style.display = 'flex';
        }
        
        function toggleRoundTrip() {
            const flightType = document.getElementById('flight-type').value;
            const inboundFlight = document.getElementById('inbound-flight');
            
            if (flightType === 'roundtrip') {
                inboundFlight.style.display = 'block';
            } else {
                inboundFlight.style.display = 'none';
            }
        }
        
        function saveFlight() {
            const flightType = document.getElementById('flight-type').value;
            const isRoundTrip = flightType === 'roundtrip';
            
            // å¦‚æœæ˜¯ä¾†å›èˆªç­ï¼Œä¿å­˜å…©å€‹èˆªç­
            if (isRoundTrip) {
                // å»ç¨‹èˆªç­
                const outboundFlight = {
                    id: editingFlightId || Date.now(),
                    airline: document.getElementById('outbound-airline').value,
                    flightNumber: document.getElementById('outbound-flight-number').value,
                    departureCity: document.getElementById('outbound-departure-city').value,
                    departureAirport: document.getElementById('outbound-departure-airport').value,
                    departureTime: document.getElementById('outbound-departure-time').value,
                    arrivalCity: document.getElementById('outbound-arrival-city').value,
                    arrivalAirport: document.getElementById('outbound-arrival-airport').value,
                    arrivalTime: document.getElementById('outbound-arrival-time').value,
                    date: document.getElementById('outbound-date').value,
                    class: document.getElementById('outbound-class').value,
                    seat: document.getElementById('outbound-seat').value,
                    remarks: document.getElementById('outbound-remarks').value,
                    isOutbound: true,
                    isRoundTrip: true
                };
                
                // å›ç¨‹èˆªç­
                const inboundFlight = {
                    id: (editingFlightId || Date.now()) + 1,
                    airline: document.getElementById('inbound-airline').value,
                    flightNumber: document.getElementById('inbound-flight-number').value,
                    departureCity: document.getElementById('inbound-departure-city').value,
                    departureAirport: document.getElementById('inbound-departure-airport').value,
                    departureTime: document.getElementById('inbound-departure-time').value,
                    arrivalCity: document.getElementById('inbound-arrival-city').value,
                    arrivalAirport: document.getElementById('inbound-arrival-airport').value,
                    arrivalTime: document.getElementById('inbound-arrival-time').value,
                    date: document.getElementById('inbound-date').value,
                    class: document.getElementById('inbound-class').value,
                    seat: document.getElementById('inbound-seat').value,
                    remarks: document.getElementById('inbound-remarks').value,
                    isOutbound: false,
                    isRoundTrip: true
                };
                
                // åˆªé™¤ç¾æœ‰çš„èˆªç­ï¼ˆå¦‚æœæ˜¯ç·¨è¼¯ï¼‰
                if (editingFlightId) {
                    tripInfo.flights = tripInfo.flights.filter(f => f.id !== editingFlightId && f.id !== editingFlightId + 1);
                }
                
                // æ·»åŠ æ–°èˆªç­
                tripInfo.flights.push(outboundFlight);
                tripInfo.flights.push(inboundFlight);
            } else {
                // å–®ç¨‹èˆªç­
                const flight = {
                    id: editingFlightId || Date.now(),
                    airline: document.getElementById('outbound-airline').value,
                    flightNumber: document.getElementById('outbound-flight-number').value,
                    departureCity: document.getElementById('outbound-departure-city').value,
                    departureAirport: document.getElementById('outbound-departure-airport').value,
                    departureTime: document.getElementById('outbound-departure-time').value,
                    arrivalCity: document.getElementById('outbound-arrival-city').value,
                    arrivalAirport: document.getElementById('outbound-arrival-airport').value,
                    arrivalTime: document.getElementById('outbound-arrival-time').value,
                    date: document.getElementById('outbound-date').value,
                    class: document.getElementById('outbound-class').value,
                    seat: document.getElementById('outbound-seat').value,
                    remarks: document.getElementById('outbound-remarks').value + (document.getElementById('flight-general-remarks').value ? '\n' + document.getElementById('flight-general-remarks').value : ''),
                    isOutbound: true,
                    isRoundTrip: false
                };
                
                // åˆªé™¤ç¾æœ‰çš„èˆªç­ï¼ˆå¦‚æœæ˜¯ç·¨è¼¯ï¼‰
                if (editingFlightId) {
                    tripInfo.flights = tripInfo.flights.filter(f => f.id !== editingFlightId);
                }
                
                // æ·»åŠ æ–°èˆªç­
                tripInfo.flights.push(flight);
            }
            
            saveTripInfo();
            renderFlights();
            closeModal('flight-modal');
            alert('èˆªç­è³‡è¨Šå·²å„²å­˜ï¼');
        }
        
        function deleteFlight(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹èˆªç­å—ï¼Ÿ')) {
                // å¦‚æœæ˜¯ä¾†å›èˆªç­ï¼Œåˆªé™¤å…©å€‹èˆªç­
                const flight = tripInfo.flights.find(f => f.id === id);
                if (flight && flight.isRoundTrip) {
                    tripInfo.flights = tripInfo.flights.filter(f => f.id !== id && f.id !== id + 1);
                } else {
                    tripInfo.flights = tripInfo.flights.filter(f => f.id !== id);
                }
                
                saveTripInfo();
                renderFlights();
            }
        }
        
        // é…’åº—ç·¨è¼¯åŠŸèƒ½
        let editingHotelId = null;
        
        function editHotel(id = null) {
            editingHotelId = id;
            
            if (id) {
                const hotel = tripInfo.hotels.find(h => h.id === id);
                if (hotel) {
                    document.getElementById('hotel-name').value = hotel.name || '';
                    document.getElementById('hotel-address').value = hotel.address || '';
                    document.getElementById('hotel-checkin').value = hotel.checkin || '';
                    document.getElementById('hotel-checkout').value = hotel.checkout || '';
                    document.getElementById('hotel-remarks-input').value = hotel.remarks || '';
                }
            } else {
                document.getElementById('hotel-name').value = '';
                document.getElementById('hotel-address').value = '';
                document.getElementById('hotel-checkin').value = '';
                document.getElementById('hotel-checkout').value = '';
                document.getElementById('hotel-remarks-input').value = '';
            }
            
            document.getElementById('hotel-modal').style.display = 'flex';
        }
        
        function saveHotel() {
            const hotel = {
                id: editingHotelId || Date.now(),
                name: document.getElementById('hotel-name').value,
                address: document.getElementById('hotel-address').value,
                checkin: document.getElementById('hotel-checkin').value,
                checkout: document.getElementById('hotel-checkout').value,
                remarks: document.getElementById('hotel-remarks-input').value
            };
            
            if (editingHotelId) {
                const index = tripInfo.hotels.findIndex(h => h.id === editingHotelId);
                if (index !== -1) {
                    tripInfo.hotels[index] = hotel;
                }
            } else {
                tripInfo.hotels.push(hotel);
            }
            
            saveTripInfo();
            renderHotels();
            closeModal('hotel-modal');
            
            // æ›´æ–°åœ°åœ–
            if (map) {
                updateMap();
            }
            
            alert('é…’åº—è³‡è¨Šå·²å„²å­˜ï¼');
        }
        
        function deleteHotel(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é…’åº—å—ï¼Ÿ')) {
                tripInfo.hotels = tripInfo.hotels.filter(h => h.id !== id);
                saveTripInfo();
                renderHotels();
                
                // æ›´æ–°åœ°åœ–
                if (map) {
                    updateMap();
                }
            }
        }
        
        // ç§Ÿè»Šç·¨è¼¯åŠŸèƒ½
        let editingCarId = null;
        
        function editCar(id = null) {
            editingCarId = id;
            
            if (id) {
                const car = tripInfo.cars.find(c => c.id === id);
                if (car) {
                    document.getElementById('car-company').value = car.company || '';
                    document.getElementById('car-pickup-location').value = car.pickupLocation || '';
                    document.getElementById('car-return-location').value = car.returnLocation || '';
                    document.getElementById('car-pickup-time').value = car.pickupTime || '';
                    document.getElementById('car-return-time').value = car.returnTime || '';
                    document.getElementById('car-remarks-input').value = car.remarks || '';
                }
            } else {
                document.getElementById('car-company').value = '';
                document.getElementById('car-pickup-location').value = '';
                document.getElementById('car-return-location').value = '';
                document.getElementById('car-pickup-time').value = '';
                document.getElementById('car-return-time').value = '';
                document.getElementById('car-remarks-input').value = '';
            }
            
            document.getElementById('car-modal').style.display = 'flex';
        }
        
        function saveCar() {
            const car = {
                id: editingCarId || Date.now(),
                company: document.getElementById('car-company').value,
                pickupLocation: document.getElementById('car-pickup-location').value,
                returnLocation: document.getElementById('car-return-location').value,
                pickupTime: document.getElementById('car-pickup-time').value,
                returnTime: document.getElementById('car-return-time').value,
                remarks: document.getElementById('car-remarks-input').value
            };
            
            if (editingCarId) {
                const index = tripInfo.cars.findIndex(c => c.id === editingCarId);
                if (index !== -1) {
                    tripInfo.cars[index] = car;
                }
            } else {
                tripInfo.cars.push(car);
            }
            
            saveTripInfo();
            renderCars();
            closeModal('car-modal');
            
            // æ›´æ–°åœ°åœ–
            if (map) {
                updateMap();
            }
            
            alert('ç§Ÿè»Šè³‡è¨Šå·²å„²å­˜ï¼');
        }
        
        function deleteCar(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç§Ÿè»Šè³‡è¨Šå—ï¼Ÿ')) {
                tripInfo.cars = tripInfo.cars.filter(c => c.id !== id);
                saveTripInfo();
                renderCars();
                
                // æ›´æ–°åœ°åœ–
                if (map) {
                    updateMap();
                }
            }
        }
        
        // å…¶ä»–è³‡è¨Šç·¨è¼¯åŠŸèƒ½
        let editingOtherId = null;
        
        function editOther(id = null) {
            editingOtherId = id;
            
            if (id) {
                const other = tripInfo.others.find(o => o.id === id);
                if (other) {
                    document.getElementById('other-title-input').value = other.title || '';
                    document.getElementById('other-content-input').value = other.content || '';
                }
            } else {
                document.getElementById('other-title-input').value = '';
                document.getElementById('other-content-input').value = '';
            }
            
            document.getElementById('other-modal').style.display = 'flex';
        }
        
        function saveOther() {
            const other = {
                id: editingOtherId || Date.now(),
                title: document.getElementById('other-title-input').value,
                content: document.getElementById('other-content-input').value
            };
            
            if (editingOtherId) {
                const index = tripInfo.others.findIndex(o => o.id === editingOtherId);
                if (index !== -1) {
                    tripInfo.others[index] = other;
                }
            } else {
                tripInfo.others.push(other);
            }
            
            saveTripInfo();
            renderOthers();
            closeModal('other-modal');
            alert('å…¶ä»–è³‡è¨Šå·²å„²å­˜ï¼');
        }
        
        function deleteOther(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è³‡è¨Šå—ï¼Ÿ')) {
                tripInfo.others = tripInfo.others.filter(o => o.id !== id);
                saveTripInfo();
                renderOthers();
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ==================== æœ¬åœ°å„²å­˜åŠŸèƒ½ ====================
        function saveToLocalStorage() { 
            localStorage.setItem('travelActivities', JSON.stringify(activities)); 
            localStorage.setItem('dateColors', JSON.stringify(dateColors)); 
        }
        
        function saveExpensesToLocalStorage() { 
            localStorage.setItem('travelExpenses', JSON.stringify(expenses)); 
        }
        
        function saveDiaryToLocalStorage() { 
            localStorage.setItem('travelDiary', JSON.stringify(diaryEntries)); 
        }
        
        // â˜… æ–°å¢ï¼šå„²å­˜æ—…ç¨‹ç°¡ä»‹æ•¸æ“š â˜…
        function saveTripInfo() {
            localStorage.setItem('tripInfo', JSON.stringify(tripInfo));
        }
        
        function loadFromLocalStorage() {
            const savedActivities = localStorage.getItem('travelActivities');
            if (savedActivities) { 
                activities.length = 0; 
                activities.push(...JSON.parse(savedActivities)); 
                renderItinerary(); 
                updateMapLocations();
                
                // â˜… æ–°å¢ï¼šè¼‰å…¥å¾Œè¨ˆç®—äº¤é€šæ™‚é–“ â˜…
                calculateTravelTimes();
            }
            
            const savedExpenses = localStorage.getItem('travelExpenses');
            if (savedExpenses) { 
                expenses.length = 0; 
                expenses.push(...JSON.parse(savedExpenses)); 
                updateExpenseTotal();
                renderExpenses(); 
            }
            
            const savedDiary = localStorage.getItem('travelDiary');
            if (savedDiary) { 
                diaryEntries.length = 0; 
                diaryEntries.push(...JSON.parse(savedDiary)); 
                renderDiaryEntries(); 
            }
            
            // â˜… æ–°å¢ï¼šè¼‰å…¥æ—…ç¨‹ç°¡ä»‹æ•¸æ“š â˜…
            const savedTripInfo = localStorage.getItem('tripInfo');
            if (savedTripInfo) {
                tripInfo = JSON.parse(savedTripInfo);
                renderTripInfo();
            }
            
            ['itinerary', 'map', 'account', 'diary', 'trip'].forEach(page => loadBackground(page));
        }

        // ==================== é é¢åˆå§‹åŒ– ====================
        window.onload = function() {
            loadFromLocalStorage();
            renderItinerary(); 
            updateExpenseTotal();
            renderExpenses(); 
            renderDiaryEntries();
            updateMapLocations();
            renderTripInfo();
            
            // è¨­ç½®ä»Šå¤©ç‚ºé è¨­æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expense-date').value = today;
            
            console.log('æ—…è¡Œè¦åŠƒé é¢å·²è¼‰å…¥å®Œæˆï¼');
            console.log('è«‹æ›¿æ›ç¬¬15è¡Œçš„Google Maps APIé‡‘é‘°ä»¥å•Ÿç”¨åœ°åœ–å’Œäº¤é€šæ™‚é–“åŠŸèƒ½ã€‚');
        };
    </script>
</body>
            </html>
